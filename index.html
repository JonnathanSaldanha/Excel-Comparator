<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnalisadorExcel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--light);
        }

        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .description {
            color: #7f8c8d;
            margin-bottom: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .upload-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }

        .file-upload {
            flex: 1;
            min-width: 300px;
            background-color: #f8f9fa;
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: var(--secondary);
            background-color: #e8f4fc;
        }

        .file-upload h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--secondary);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 15px;
        }

        .file-label:hover {
            background-color: #2980b9;
        }

        .file-name {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .file-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .config-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .config-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .config-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .config-tab.active {
            border-bottom: 3px solid var(--secondary);
            font-weight: bold;
        }

        .config-content {
            display: none;
        }

        .config-content.active {
            display: block;
        }

        .config-options {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .config-group {
            flex: 1;
            min-width: 250px;
        }

        .config-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .config-group select, .config-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .config-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .analyze-btn {
            display: block;
            width: 200px;
            margin: 30px auto;
            padding: 15px;
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .analyze-btn:hover {
            background-color: #219653;
        }

        .analyze-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .results-section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .results-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .common, .different, .doubtful {
            flex: 1;
            min-width: 300px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .common h3, .different h3, .doubtful h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 1;
        }

        .common h3 {
            color: var(--success);
            border-color: var(--success);
        }

        .different h3 {
            color: var(--danger);
            border-color: var(--danger);
        }

        .doubtful h3 {
            color: var(--warning);
            border-color: var(--warning);
        }

        .result-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
        }

        .result-details {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .download-btn {
            display: block;
            width: 250px;
            margin: 20px auto;
            padding: 15px;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .download-btn:hover {
            background-color: #8e44ad;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--secondary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--secondary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .summary-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
            min-width: 200px;
        }

        .summary-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        .only-in-file1 {
            border-left: 4px solid var(--warning);
        }

        .only-in-file2 {
            border-left: 4px solid var(--danger);
        }

        .matches {
            border-left: 4px solid var(--success);
        }

        .doubtful-matches {
            border-left: 4px solid var(--warning);
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .filter-group input, .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .error-message {
            background-color: #ffe6e6;
            color: var(--danger);
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background-color: #e6ffe6;
            color: var(--success);
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .debug-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .debug-toggle {
            color: var(--secondary);
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .upload-section {
                flex-direction: column;
            }
            
            .file-upload {
                width: 100%;
            }
            
            .results-container {
                flex-direction: column;
            }

            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AnalisadorExcel</h1>
            <p class="description">Faça upload de dois arquivos Excel com dados de pagamentos para identificar correspondências mesmo com diferenças de formatação e gere um relatório detalhado.</p>
        </header>

        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>

        <div class="upload-section">
            <div class="file-upload">
                <h3>Arquivo 1</h3>
                <label for="file1" class="file-label">Selecionar Arquivo</label>
                <input type="file" id="file1" class="file-input" accept=".xlsx, .xls">
                <div id="file1-name" class="file-name">Nenhum arquivo selecionado</div>
                <div id="file1-error" class="file-error"></div>
            </div>

            <div class="file-upload">
                <h3>Arquivo 2</h3>
                <label for="file2" class="file-label">Selecionar Arquivo</label>
                <input type="file" id="file2" class="file-input" accept=".xlsx, .xls">
                <div id="file2-name" class="file-name">Nenhum arquivo selecionado</div>
                <div id="file2-error" class="file-error"></div>
            </div>
        </div>

        <div class="config-section">
            <h3>Configurações de Comparação</h3>
            
            <div class="config-tabs">
                <div class="config-tab active" data-tab="file1">Configurações Arquivo 1</div>
                <div class="config-tab" data-tab="file2">Configurações Arquivo 2</div>
                <div class="config-tab" data-tab="global">Configurações Globais</div>
            </div>
            
            <div class="config-content active" id="file1-config">
                <div class="config-options">
                    <div class="config-group">
                        <label for="file1-coluna1">Coluna de Comparação 01:</label>
                        <select id="file1-coluna1">
                            <option value="">Selecionar coluna</option>
                        </select>
                        <div id="file1-coluna1-error" class="config-error">Selecione uma coluna para Comparação 01</div>
                    </div>
                    <div class="config-group">
                        <label for="file1-coluna2">Coluna de Comparação 02:</label>
                        <select id="file1-coluna2">
                            <option value="">Selecionar coluna</option>
                        </select>
                        <div id="file1-coluna2-error" class="config-error">Selecione uma coluna para Comparação 02</div>
                    </div>
                    <div class="config-group">
                        <label for="file1-coluna3">Coluna de Comparação 03:</label>
                        <select id="file1-coluna3">
                            <option value="">Selecionar coluna</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label for="file1-coluna4">Coluna de Comparação 04:</label>
                        <select id="file1-coluna4">
                            <option value="">Selecionar coluna</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="config-content" id="file2-config">
                <div class="config-options">
                    <div class="config-group">
                        <label for="file2-coluna1">Coluna de Comparação 01:</label>
                        <select id="file2-coluna1">
                            <option value="">Selecionar coluna</option>
                        </select>
                        <div id="file2-coluna1-error" class="config-error">Selecione uma coluna para Comparação 01</div>
                    </div>
                    <div class="config-group">
                        <label for="file2-coluna2">Coluna de Comparação 02:</label>
                        <select id="file2-coluna2">
                            <option value="">Selecionar coluna</option>
                        </select>
                        <div id="file2-coluna2-error" class="config-error">Selecione uma coluna para Comparação 02</div>
                    </div>
                    <div class="config-group">
                        <label for="file2-coluna3">Coluna de Comparação 03:</label>
                        <select id="file2-coluna3">
                            <option value="">Selecionar coluna</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label for="file2-coluna4">Coluna de Comparação 04:</label>
                        <select id="file2-coluna4">
                            <option value="">Selecionar coluna</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="config-content" id="global-config">
                <div class="config-options">
                    <div class="config-group">
                        <label for="tolerancia">Tolerância de valores:</label>
                        <input type="number" id="tolerancia" value="0.01" step="0.01" min="0">
                    </div>
                    <div class="config-group">
                        <label for="ignorar-caracteres">Ignorar caracteres especiais na Coluna 01:</label>
                        <select id="ignorar-caracteres">
                            <option value="sim" selected>Sim</option>
                            <option value="nao">Não</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label for="comparar-coluna3">Comparar Coluna 03 (similaridade):</label>
                        <select id="comparar-coluna3">
                            <option value="sim" selected>Sim</option>
                            <option value="nao">Não</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label for="tolerancia-duvidosos">Tolerância para correspondências duvidosas:</label>
                        <input type="number" id="tolerancia-duvidosos" value="0.05" step="0.01" min="0">
                    </div>
                </div>
            </div>
        </div>

        <button id="analyze-btn" class="analyze-btn" disabled>Analisar Arquivos</button>

        <div class="loading">
            <div class="spinner"></div>
            <p>Processando arquivos...</p>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <div id="results-section" class="results-section">
            <h2>Resultados da Análise</h2>
            
            <div class="summary">
                <div class="summary-item only-in-file1">
                    <div class="summary-number" id="only-in-file1-count">0</div>
                    <div class="summary-label">Apenas no Arquivo 1</div>
                </div>
                <div class="summary-item only-in-file2">
                    <div class="summary-number" id="only-in-file2-count">0</div>
                    <div class="summary-label">Apenas no Arquivo 2</div>
                </div>
                <div class="summary-item matches">
                    <div class="summary-number" id="matches-count">0</div>
                    <div class="summary-label">Correspondências</div>
                </div>
                <div class="summary-item doubtful-matches">
                    <div class="summary-number" id="doubtful-count">0</div>
                    <div class="summary-label">Correspondências Duvidosas</div>
                </div>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="filter-coluna1">Filtrar por Coluna 01:</label>
                    <input type="text" id="filter-coluna1" placeholder="Digite o valor...">
                </div>
                <div class="filter-group">
                    <label for="filter-coluna3">Filtrar por Coluna 03:</label>
                    <input type="text" id="filter-coluna3" placeholder="Digite o valor...">
                </div>
                <div class="filter-group">
                    <label for="filter-status">Filtrar por Status:</label>
                    <select id="filter-status">
                        <option value="todos">Todos</option>
                        <option value="apenas-arquivo1">Apenas no Arquivo 1</option>
                        <option value="apenas-arquivo2">Apenas no Arquivo 2</option>
                        <option value="correspondentes">Correspondentes</option>
                        <option value="duvidosos">Correspondências Duvidosas</option>
                    </select>
                </div>
            </div>
            
            <div class="results-container">
                <div class="common">
                    <h3>Correspondências Encontradas</h3>
                    <div id="common-results"></div>
                </div>
                <div class="doubtful">
                    <h3>Correspondências Duvidosas</h3>
                    <div id="doubtful-results"></div>
                </div>
                <div class="different">
                    <h3>Divergências</h3>
                    <div id="different-results"></div>
                </div>
            </div>
            
            <button id="download-btn" class="download-btn">Baixar Relatório Completo</button>
            
            <div class="debug-toggle" id="debug-toggle">Mostrar informações de depuração</div>
            <div class="debug-info" id="debug-info"></div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let file1Data = null;
        let file2Data = null;
        let file1Columns = [];
        let file2Columns = [];
        let results = null;
        let file1Name = '';
        let file2Name = '';

        // Elementos DOM
        const file1Input = document.getElementById('file1');
        const file2Input = document.getElementById('file2');
        const file1NameDisplay = document.getElementById('file1-name');
        const file2NameDisplay = document.getElementById('file2-name');
        const file1Error = document.getElementById('file1-error');
        const file2Error = document.getElementById('file2-error');
        const analyzeBtn = document.getElementById('analyze-btn');
        const loadingSection = document.querySelector('.loading');
        const resultsSection = document.getElementById('results-section');
        const commonResults = document.getElementById('common-results');
        const doubtfulResults = document.getElementById('doubtful-results');
        const differentResults = document.getElementById('different-results');
        const downloadBtn = document.getElementById('download-btn');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const debugToggle = document.getElementById('debug-toggle');
        const debugInfo = document.getElementById('debug-info');
        const progressBar = document.getElementById('progress-bar');
        const configTabs = document.querySelectorAll('.config-tab');

        // Event Listeners
        file1Input.addEventListener('change', (e) => handleFileUpload(e, 1));
        file2Input.addEventListener('change', (e) => handleFileUpload(e, 2));
        analyzeBtn.addEventListener('click', analyzeFiles);
        downloadBtn.addEventListener('click', downloadReport);
        debugToggle.addEventListener('click', toggleDebugInfo);
        
        // Adicionar event listeners para as abas de configuração
        configTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Remover classe active de todas as abas e conteúdos
                configTabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.config-content').forEach(c => c.classList.remove('active'));
                
                // Adicionar classe active à aba e conteúdo clicados
                tab.classList.add('active');
                document.getElementById(`${tabId}-config`).classList.add('active');
            });
        });

        // Funções
        function handleFileUpload(event, fileNumber) {
            const file = event.target.files[0];
            const fileNameElement = document.getElementById(`file${fileNumber}-name`);
            const fileErrorElement = document.getElementById(`file${fileNumber}-error`);
            
            if (!file) return;
            
            // Salvar o nome do arquivo
            if (fileNumber === 1) {
                file1Name = file.name;
            } else {
                file2Name = file.name;
            }
            
            // Verificar se é um arquivo Excel
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                fileErrorElement.textContent = 'Por favor, selecione um arquivo Excel válido.';
                fileErrorElement.style.display = 'block';
                fileNameElement.textContent = 'Arquivo inválido';
                event.target.value = '';
                updateAnalyzeButton();
                return;
            }
            
            fileErrorElement.style.display = 'none';
            fileNameElement.textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Pegar a primeira planilha
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Converter para JSON
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Extrair cabeçalhos (primeira linha)
                    const headers = jsonData[0];
                    
                    // Salvar dados e cabeçalhos
                    if (fileNumber === 1) {
                        file1Data = jsonData;
                        file1Columns = headers;
                        populateColumnDropdown('file1', headers);
                    } else {
                        file2Data = jsonData;
                        file2Columns = headers;
                        populateColumnDropdown('file2', headers);
                    }
                    
                    updateAnalyzeButton();
                    showSuccess(`Arquivo ${fileNumber} carregado com sucesso!`);
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    fileErrorElement.textContent = 'Erro ao processar o arquivo. Verifique se é um Excel válido.';
                    fileErrorElement.style.display = 'block';
                    fileNameElement.textContent = 'Erro no processamento';
                }
            };
            
            reader.onerror = function() {
                fileErrorElement.textContent = 'Erro ao ler o arquivo.';
                fileErrorElement.style.display = 'block';
                fileNameElement.textContent = 'Erro de leitura';
            };
            
            reader.readAsArrayBuffer(file);
        }

        function populateColumnDropdown(filePrefix, headers) {
            // Limpar dropdowns existentes
            const dropdowns = [
                `${filePrefix}-coluna1`,
                `${filePrefix}-coluna2`,
                `${filePrefix}-coluna3`,
                `${filePrefix}-coluna4`
            ];
            
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                // Manter a primeira opção e limpar o resto
                dropdown.innerHTML = '<option value="">Selecionar coluna</option>';
                
                // Adicionar opções para cada cabeçalho
                headers.forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${header} (Coluna ${index + 1})`;
                    dropdown.appendChild(option);
                });
            });
        }

        function updateAnalyzeButton() {
            // Habilitar o botão apenas se ambos os arquivos foram carregados
            const file1Loaded = file1Data !== null;
            const file2Loaded = file2Data !== null;
            
            analyzeBtn.disabled = !(file1Loaded && file2Loaded);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            
            // Rolar para a mensagem de erro
            errorMessage.scrollIntoView({ behavior: 'smooth' });
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        function analyzeFiles() {
            // Validar seleção de colunas
            const file1Coluna1 = document.getElementById('file1-coluna1').value;
            const file1Coluna2 = document.getElementById('file1-coluna2').value;
            const file2Coluna1 = document.getElementById('file2-coluna1').value;
            const file2Coluna2 = document.getElementById('file2-coluna2').value;
            
            if (file1Coluna1 === '' || file1Coluna2 === '' || file2Coluna1 === '' || file2Coluna2 === '') {
                showError('Por favor, selecione as colunas obrigatórias (Comparação 01 e 02) para ambos os arquivos.');
                return;
            }
            
            hideMessages();
            
            // Mostrar loading
            loadingSection.style.display = 'block';
            analyzeBtn.disabled = true;
            progressBar.style.width = '0%';
            
            // Simular progresso (em um caso real, isso seria baseado no processamento real)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                progressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    processComparison();
                }
            }, 100);
        }

        function processComparison() {
            try {
                // Obter configurações
                const file1Coluna1 = parseInt(document.getElementById('file1-coluna1').value);
                const file1Coluna2 = parseInt(document.getElementById('file1-coluna2').value);
                const file1Coluna3 = document.getElementById('file1-coluna3').value;
                const file1Coluna4 = document.getElementById('file1-coluna4').value;
                
                const file2Coluna1 = parseInt(document.getElementById('file2-coluna1').value);
                const file2Coluna2 = parseInt(document.getElementById('file2-coluna2').value);
                const file2Coluna3 = document.getElementById('file2-coluna3').value;
                const file2Coluna4 = document.getElementById('file2-coluna4').value;
                
                const tolerancia = parseFloat(document.getElementById('tolerancia').value);
                const toleranciaDuvidosos = parseFloat(document.getElementById('tolerancia-duvidosos').value);
                const ignorarCaracteres = document.getElementById('ignorar-caracteres').value === 'sim';
                const compararColuna3 = document.getElementById('comparar-coluna3').value === 'sim';
                
                // Processar dados (ignorar cabeçalhos)
                const processedFile1 = processData(file1Data, 1, file1Coluna1, file1Coluna2, file1Coluna3, file1Coluna4, ignorarCaracteres);
                const processedFile2 = processData(file2Data, 2, file2Coluna1, file2Coluna2, file2Coluna3, file2Coluna4, ignorarCaracteres);
                
                // Comparar os dados
                results = compareData(processedFile1, processedFile2, tolerancia, toleranciaDuvidosos, compararColuna3);
                
                // Exibir resultados
                displayResults(results);
                
                // Esconder loading e mostrar resultados
                loadingSection.style.display = 'none';
                resultsSection.style.display = 'block';
                
                // Rolar para os resultados
                resultsSection.scrollIntoView({ behavior: 'smooth' });
                
                showSuccess('Análise concluída com sucesso!');
            } catch (error) {
                console.error('Erro durante a análise:', error);
                loadingSection.style.display = 'none';
                showError('Ocorreu um erro durante a análise. Verifique os arquivos e tente novamente.');
                analyzeBtn.disabled = false;
            }
        }

        function processData(data, fileNumber, coluna1, coluna2, coluna3, coluna4, ignorarCaracteres) {
            const processed = [];
            
            // Ignorar a primeira linha (cabeçalhos)
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                
                // Extrair valores das colunas selecionadas
                let valorColuna1 = row[coluna1];
                let valorColuna2 = row[coluna2];
                let valorColuna3 = coluna3 !== '' ? row[coluna3] : '';
                let valorColuna4 = coluna4 !== '' ? row[coluna4] : '';
                
                // Processar Coluna 1
                if (valorColuna1 !== undefined && valorColuna1 !== null) {
                    valorColuna1 = valorColuna1.toString().trim();
                    
                    if (ignorarCaracteres) {
                        // Remover caracteres não numéricos
                        valorColuna1 = valorColuna1.replace(/\D/g, '');
                    }
                    
                    // Se após a limpeza a coluna estiver vazia, pular esta linha
                    if (valorColuna1 === '') continue;
                } else {
                    continue; // Pular linhas sem valor na coluna 1
                }
                
                // Processar Coluna 2
                if (valorColuna2 !== undefined && valorColuna2 !== null) {
                    // Converter para número, tratando diferentes formatos
                    if (typeof valorColuna2 === 'string') {
                        // Remover possíveis símbolos de moeda e espaços
                        valorColuna2 = valorColuna2.replace(/[^\d,.-]/g, '').replace(',', '.');
                    }
                    valorColuna2 = parseFloat(valorColuna2);
                    
                    // Se não for um número válido, pular esta linha
                    if (isNaN(valorColuna2)) continue;
                } else {
                    continue; // Pular linhas sem valor na coluna 2
                }
                
                // Processar Coluna 3 (se fornecida)
                if (valorColuna3 !== undefined && valorColuna3 !== null) {
                    valorColuna3 = valorColuna3.toString().trim();
                } else {
                    valorColuna3 = '';
                }
                
                // Processar Coluna 4 (se fornecida)
                if (valorColuna4 !== undefined && valorColuna4 !== null) {
                    valorColuna4 = valorColuna4.toString().trim();
                } else {
                    valorColuna4 = '';
                }
                
                // Adicionar à lista processada
                processed.push({
                    file: fileNumber,
                    originalRow: row,
                    coluna1: valorColuna1,
                    coluna2: valorColuna2,
                    coluna3: valorColuna3,
                    coluna4: valorColuna4
                });
            }
            
            return processed;
        }

        function compareData(data1, data2, tolerancia, toleranciaDuvidosos, compararColuna3) {
            const matches = [];
            const doubtfulMatches = [];
            const onlyInFile1 = [];
            const onlyInFile2 = [...data2];
            
            // Para cada item no arquivo 1, verificar se existe correspondência no arquivo 2
            for (const item1 of data1) {
                let foundMatch = false;
                let foundDoubtfulMatch = false;
                
                for (let j = 0; j < onlyInFile2.length; j++) {
                    const item2 = onlyInFile2[j];
                    
                    // Verificar se as Colunas 1 correspondem
                    if (item1.coluna1 === item2.coluna1) {
                        // Verificar se os valores da Coluna 2 estão dentro da tolerância
                        const diff = Math.abs(item1.coluna2 - item2.coluna2);
                        
                        if (diff <= tolerancia) {
                            // Verificar Coluna 3 se necessário
                            let coluna3Match = true;
                            if (compararColuna3 && item1.coluna3 && item2.coluna3) {
                                coluna3Match = areValuesSimilar(item1.coluna3, item2.coluna3);
                            }
                            
                            if (coluna3Match) {
                                // Encontrou uma correspondência
                                matches.push({
                                    item1: item1,
                                    item2: item2,
                                    diff: diff
                                });
                                
                                // Remover do array onlyInFile2
                                onlyInFile2.splice(j, 1);
                                foundMatch = true;
                                break;
                            }
                        } else if (diff <= toleranciaDuvidosos) {
                            // Verificar Coluna 3 se necessário
                            let coluna3Match = true;
                            if (compararColuna3 && item1.coluna3 && item2.coluna3) {
                                coluna3Match = areValuesSimilar(item1.coluna3, item2.coluna3);
                            }
                            
                            if (coluna3Match) {
                                // Encontrou uma correspondência duvidosa
                                doubtfulMatches.push({
                                    item1: item1,
                                    item2: item2,
                                    diff: diff
                                });
                                
                                // Remover do array onlyInFile2
                                onlyInFile2.splice(j, 1);
                                foundDoubtfulMatch = true;
                                break;
                            }
                        }
                    }
                }
                
                if (!foundMatch && !foundDoubtfulMatch) {
                    onlyInFile1.push(item1);
                }
            }
            
            return {
                matches: matches,
                doubtfulMatches: doubtfulMatches,
                onlyInFile1: onlyInFile1,
                onlyInFile2: onlyInFile2
            };
        }

        function areValuesSimilar(value1, value2) {
            // Converter para minúsculas e remover acentos
            const normalize = (str) => {
                return str.toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            };
            
            const n1 = normalize(value1);
            const n2 = normalize(value2);
            
            // Verificar se um valor contém o outro ou são iguais
            return n1 === n2 || n1.includes(n2) || n2.includes(n1);
        }

        function displayResults(results) {
            // Atualizar contadores
            document.getElementById('only-in-file1-count').textContent = results.onlyInFile1.length;
            document.getElementById('only-in-file2-count').textContent = results.onlyInFile2.length;
            document.getElementById('matches-count').textContent = results.matches.length;
            document.getElementById('doubtful-count').textContent = results.doubtfulMatches.length;
            
            // Limpar resultados anteriores
            commonResults.innerHTML = '';
            doubtfulResults.innerHTML = '';
            differentResults.innerHTML = '';
            
            // Exibir correspondências
            results.matches.forEach(match => {
                const item = document.createElement('div');
                item.className = 'result-item';
                
                const details = `
                    <div><strong>Coluna 01:</strong> ${match.item1.coluna1}</div>
                    <div><strong>Coluna 02:</strong> ${match.item1.coluna2.toFixed(2)}</div>
                    ${match.item1.coluna3 ? `<div><strong>Coluna 03:</strong> ${match.item1.coluna3}</div>` : ''}
                    ${match.item1.coluna4 ? `<div><strong>Coluna 04:</strong> ${match.item1.coluna4}</div>` : ''}
                    <div class="result-details">Correspondência exata entre ${file1Name} e ${file2Name}</div>
                `;
                
                item.innerHTML = details;
                commonResults.appendChild(item);
            });
            
            // Exibir correspondências duvidosas
            results.doubtfulMatches.forEach(match => {
                const item = document.createElement('div');
                item.className = 'result-item';
                
                const details = `
                    <div><strong>Coluna 01:</strong> ${match.item1.coluna1}</div>
                    <div><strong>Coluna 02 (${file1Name}):</strong> ${match.item1.coluna2.toFixed(2)}</div>
                    <div><strong>Coluna 02 (${file2Name}):</strong> ${match.item2.coluna2.toFixed(2)}</div>
                    <div><strong>Diferença:</strong> ${match.diff.toFixed(2)}</div>
                    ${match.item1.coluna3 ? `<div><strong>Coluna 03 (${file1Name}):</strong> ${match.item1.coluna3}</div>` : ''}
                    ${match.item2.coluna3 ? `<div><strong>Coluna 03 (${file2Name}):</strong> ${match.item2.coluna3}</div>` : ''}
                    ${match.item1.coluna4 ? `<div><strong>Coluna 04:</strong> ${match.item1.coluna4}</div>` : ''}
                    <div class="result-details">Correspondência duvidosa entre ${file1Name} e ${file2Name}</div>
                `;
                
                item.innerHTML = details;
                doubtfulResults.appendChild(item);
            });
            
            // Exibir itens apenas no arquivo 1
            results.onlyInFile1.forEach(item => {
                const elem = document.createElement('div');
                elem.className = 'result-item';
                
                const details = `
                    <div><strong>Coluna 01:</strong> ${item.coluna1}</div>
                    <div><strong>Coluna 02:</strong> ${item.coluna2.toFixed(2)}</div>
                    ${item.coluna3 ? `<div><strong>Coluna 03:</strong> ${item.coluna3}</div>` : ''}
                    ${item.coluna4 ? `<div><strong>Coluna 04:</strong> ${item.coluna4}</div>` : ''}
                    <div class="result-details">Presente apenas em ${file1Name}</div>
                `;
                
                elem.innerHTML = details;
                differentResults.appendChild(elem);
            });
            
            // Exibir itens apenas no arquivo 2
            results.onlyInFile2.forEach(item => {
                const elem = document.createElement('div');
                elem.className = 'result-item';
                
                const details = `
                    <div><strong>Coluna 01:</strong> ${item.coluna1}</div>
                    <div><strong>Coluna 02:</strong> ${item.coluna2.toFixed(2)}</div>
                    ${item.coluna3 ? `<div><strong>Coluna 03:</strong> ${item.coluna3}</div>` : ''}
                    ${item.coluna4 ? `<div><strong>Coluna 04:</strong> ${item.coluna4}</div>` : ''}
                    <div class="result-details">Presente apenas em ${file2Name}</div>
                `;
                
                elem.innerHTML = details;
                differentResults.appendChild(elem);
            });
            
            // Adicionar event listeners para os filtros
            document.getElementById('filter-coluna1').addEventListener('input', filterResults);
            document.getElementById('filter-coluna3').addEventListener('input', filterResults);
            document.getElementById('filter-status').addEventListener('change', filterResults);
        }

        function filterResults() {
            const coluna1Filter = document.getElementById('filter-coluna1').value.toLowerCase();
            const coluna3Filter = document.getElementById('filter-coluna3').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            
            // Filtrar correspondências
            const commonItems = commonResults.querySelectorAll('.result-item');
            commonItems.forEach(item => {
                const coluna1 = item.querySelector('div:first-child').textContent.toLowerCase();
                const coluna3 = item.querySelector('div:nth-child(3)') ? item.querySelector('div:nth-child(3)').textContent.toLowerCase() : '';
                const status = 'correspondentes';
                
                const show = (coluna1.includes(coluna1Filter) || coluna1Filter === '') &&
                            (coluna3.includes(coluna3Filter) || coluna3Filter === '') &&
                            (statusFilter === 'todos' || statusFilter === 'correspondentes');
                
                item.style.display = show ? 'flex' : 'none';
            });
            
            // Filtrar correspondências duvidosas
            const doubtfulItems = doubtfulResults.querySelectorAll('.result-item');
            doubtfulItems.forEach(item => {
                const coluna1 = item.querySelector('div:first-child').textContent.toLowerCase();
                const coluna3 = item.querySelector('div:nth-child(5)') ? item.querySelector('div:nth-child(5)').textContent.toLowerCase() : '';
                const status = 'duvidosos';
                
                const show = (coluna1.includes(coluna1Filter) || coluna1Filter === '') &&
                            (coluna3.includes(coluna3Filter) || coluna3Filter === '') &&
                            (statusFilter === 'todos' || statusFilter === 'duvidosos');
                
                item.style.display = show ? 'flex' : 'none';
            });
            
            // Filtrar divergências
            const differentItems = differentResults.querySelectorAll('.result-item');
            differentItems.forEach(item => {
                const coluna1 = item.querySelector('div:first-child').textContent.toLowerCase();
                const coluna3 = item.querySelector('div:nth-child(3)') ? item.querySelector('div:nth-child(3)').textContent.toLowerCase() : '';
                const statusText = item.querySelector('.result-details').textContent.toLowerCase();
                let status = '';
                
                if (statusText.includes(file1Name.toLowerCase())) status = 'apenas-arquivo1';
                if (statusText.includes(file2Name.toLowerCase())) status = 'apenas-arquivo2';
                
                const show = (coluna1.includes(coluna1Filter) || coluna1Filter === '') &&
                            (coluna3.includes(coluna3Filter) || coluna3Filter === '') &&
                            (statusFilter === 'todos' || statusFilter === status);
                
                item.style.display = show ? 'flex' : 'none';
            });
        }

        function downloadReport() {
            // Criar um workbook para o relatório
            const wb = XLSX.utils.book_new();
            
            // Adicionar aba de correspondências
            const matchesData = [
                ['Coluna 01', 'Coluna 02 Arquivo 1', 'Coluna 02 Arquivo 2', 'Diferença', 'Coluna 03 Arquivo 1', 'Coluna 03 Arquivo 2', 'Coluna 04 Arquivo 1', 'Coluna 04 Arquivo 2', 'Status', 'Origem Arquivo 1', 'Origem Arquivo 2']
            ];
            
            results.matches.forEach(match => {
                matchesData.push([
                    match.item1.coluna1,
                    match.item1.coluna2,
                    match.item2.coluna2,
                    match.diff,
                    match.item1.coluna3,
                    match.item2.coluna3,
                    match.item1.coluna4,
                    match.item2.coluna4,
                    'Correspondência',
                    file1Name,
                    file2Name
                ]);
            });
            
            const matchesSheet = XLSX.utils.aoa_to_sheet(matchesData);
            XLSX.utils.book_append_sheet(wb, matchesSheet, 'Correspondências');
            
            // Adicionar aba de correspondências duvidosas
            const doubtfulData = [
                ['Coluna 01', 'Coluna 02 Arquivo 1', 'Coluna 02 Arquivo 2', 'Diferença', 'Coluna 03 Arquivo 1', 'Coluna 03 Arquivo 2', 'Coluna 04 Arquivo 1', 'Coluna 04 Arquivo 2', 'Status', 'Origem Arquivo 1', 'Origem Arquivo 2']
            ];
            
            results.doubtfulMatches.forEach(match => {
                doubtfulData.push([
                    match.item1.coluna1,
                    match.item1.coluna2,
                    match.item2.coluna2,
                    match.diff,
                    match.item1.coluna3,
                    match.item2.coluna3,
                    match.item1.coluna4,
                    match.item2.coluna4,
                    'Correspondência Duvidosa',
                    file1Name,
                    file2Name
                ]);
            });
            
            const doubtfulSheet = XLSX.utils.aoa_to_sheet(doubtfulData);
            XLSX.utils.book_append_sheet(wb, doubtfulSheet, 'Correspondências Duvidosas');
            
            // Adicionar aba de apenas no arquivo 1
            const onlyInFile1Data = [
                ['Coluna 01', 'Coluna 02', 'Coluna 03', 'Coluna 04', 'Status', 'Origem']
            ];
            
            results.onlyInFile1.forEach(item => {
                onlyInFile1Data.push([
                    item.coluna1,
                    item.coluna2,
                    item.coluna3,
                    item.coluna4,
                    'Apenas no Arquivo 1',
                    file1Name
                ]);
            });
            
            const onlyInFile1Sheet = XLSX.utils.aoa_to_sheet(onlyInFile1Data);
            XLSX.utils.book_append_sheet(wb, onlyInFile1Sheet, `Apenas em ${file1Name.substring(0, 30)}`);
            
            // Adicionar aba de apenas no arquivo 2
            const onlyInFile2Data = [
                ['Coluna 01', 'Coluna 02', 'Coluna 03', 'Coluna 04', 'Status', 'Origem']
            ];
            
            results.onlyInFile2.forEach(item => {
                onlyInFile2Data.push([
                    item.coluna1,
                    item.coluna2,
                    item.coluna3,
                    item.coluna4,
                    'Apenas no Arquivo 2',
                    file2Name
                ]);
            });
            
            const onlyInFile2Sheet = XLSX.utils.aoa_to_sheet(onlyInFile2Data);
            XLSX.utils.book_append_sheet(wb, onlyInFile2Sheet, `Apenas em ${file2Name.substring(0, 30)}`);
            
            // Gerar arquivo e fazer download
            XLSX.writeFile(wb, 'relatorio_analise.xlsx');
            
            showSuccess('Relatório baixado com sucesso!');
        }

        function toggleDebugInfo() {
            if (debugInfo.style.display === 'none' || debugInfo.style.display === '') {
                debugInfo.style.display = 'block';
                debugToggle.textContent = 'Ocultar informações de depuração';
                
                // Preencher informações de depuração
                let debugContent = '';
                
                if (file1Data) {
                    debugContent += `Arquivo 1 (${file1Name}): ${file1Data.length - 1} linhas de dados\n`;
                    debugContent += `Colunas: ${file1Columns.join(', ')}\n\n`;
                }
                
                if (file2Data) {
                    debugContent += `Arquivo 2 (${file2Name}): ${file2Data.length - 1} linhas de dados\n`;
                    debugContent += `Colunas: ${file2Columns.join(', ')}\n\n`;
                }
                
                if (results) {
                    debugContent += `Resultados:\n`;
                    debugContent += `- Correspondências: ${results.matches.length}\n`;
                    debugContent += `- Correspondências Duvidosas: ${results.doubtfulMatches.length}\n`;
                    debugContent += `- Apenas no Arquivo 1: ${results.onlyInFile1.length}\n`;
                    debugContent += `- Apenas no Arquivo 2: ${results.onlyInFile2.length}\n`;
                }
                
                debugInfo.textContent = debugContent;
            } else {
                debugInfo.style.display = 'none';
                debugToggle.textContent = 'Mostrar informações de depuração';
            }
        }
    </script>
</body>
</html>
