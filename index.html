<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Arquivos Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .card-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }
        
        .upload-area {
            border: 2px dashed var(--secondary-color);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .upload-area:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .upload-area.dragover {
            background-color: rgba(52, 152, 219, 0.2);
            border-color: var(--primary-color);
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
            display: inline-block;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: var(--light-color);
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .file-name {
            font-weight: 600;
        }
        
        .file-size {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .config-section {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .column-selection-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
            margin-top: 10px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .checkbox-group:hover {
            background-color: #eef5ff;
        }
        
        .checkbox-group input {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .select-all-container {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .results-section {
            display: none;
        }
        
        .results-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .results-tab {
            padding: 12px 25px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            background-color: #f2f2f2;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .results-tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
            color: var(--primary-color);
        }
        
        .results-tab:hover:not(.active) {
            background-color: #e9e9e9;
        }
        
        .results-container {
            display: none;
        }
        
        .results-container.active {
            display: block;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem;
        }
        
        .results-table th, .results-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .results-table th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }
        
        .results-table tr:hover {
            background-color: #f1f8ff;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .match-row {
            background-color: rgba(46, 204, 113, 0.1);
        }
        
        .only-in-file1 {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .only-in-file2 {
            background-color: rgba(241, 196, 15, 0.1);
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .column-info {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .file-preview {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .preview-table th, .preview-table td {
            padding: 8px 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .preview-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        .preview-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .file-tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .file-tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            background-color: #f2f2f2;
        }
        
        .file-tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .preview-container {
            display: none;
        }
        
        .preview-container.active {
            display: block;
        }
        
        .column-tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .column-tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            background-color: #f2f2f2;
        }
        
        .column-tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .column-container {
            display: none;
        }
        
        .column-container.active {
            display: block;
        }
        
        .comparison-info {
            background-color: #e8f4fd;
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .error-message {
            background-color: #ffeaa7;
            border-left: 4px solid #fdcb6e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .stat-card.match {
            border-left-color: var(--success-color);
        }
        
        .stat-card.file1-only {
            border-left-color: var(--secondary-color);
        }
        
        .stat-card.file2-only {
            border-left-color: var(--warning-color);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .export-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.8rem;
            display: none;
        }

        .high-similarity {
            color: var(--success-color);
            font-weight: bold;
        }

        .comparison-row {
            border-left: 4px solid var(--success-color);
        }

        /* NOVOS ESTILOS ADICIONADOS */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button.active {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .pagination button:hover:not(.active) {
            background-color: #f0f0f0;
        }

        .examples-section {
            background-color: #e8f6f3;
            border-left: 4px solid var(--success-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .examples-section h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .examples-section ul {
            margin-left: 20px;
        }

        .examples-section li {
            margin-bottom: 8px;
        }

        .keyboard-shortcuts {
            background-color: #fff8e1;
            border: 1px solid #ffd54f;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ffecb3;
        }

        .settings-panel {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .performance-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .batch-comparison {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Comparador de Arquivos Excel</h1>
            <p class="subtitle">Encontre semelhan√ßas entre arquivos Excel, mesmo em linhas e colunas diferentes</p>
        </header>
        
        <div class="error-message" id="errorMessage"></div>
        
        <!-- Se√ß√£o de Exemplos -->
        <div class="examples-section">
            <h4>üí° Exemplos de Uso:</h4>
            <ul>
                <li><strong>Comparar listas de clientes</strong> de diferentes sistemas</li>
                <li><strong>Encontrar duplicatas</strong> em bases de dados diferentes</li>
                <li><strong>Reconciliar planilhas</strong> com formatos diferentes</li>
                <li><strong>Validar migra√ß√£o</strong> de dados entre sistemas</li>
            </ul>
        </div>

        <div class="card">
            <h2 class="card-title">Upload de Arquivos 
                <span class="tooltip">‚ÑπÔ∏è
                    <span class="tooltiptext">
                        Arraste ou selecione arquivos Excel (.xlsx, .xls). 
                        Voc√™ pode comparar m√∫ltiplos arquivos simultaneamente.
                    </span>
                </span>
            </h2>
            
            <div class="upload-area" id="uploadArea">
                <p>Arraste e solte seus arquivos Excel aqui ou</p>
                <button class="btn" id="browseBtn">Selecionar Arquivos</button>
                <input type="file" id="fileInput" class="file-input" multiple accept=".xlsx, .xls">
                <p class="file-types">Formatos suportados: .xlsx, .xls</p>
                <p class="performance-warning">
                    ‚ö†Ô∏è <strong>Dica:</strong> Para arquivos grandes (+10MB), considere dividir em partes menores para melhor performance.
                </p>
            </div>
            
            <div class="file-list" id="fileList"></div>
            
            <button class="btn btn-danger" id="clearFiles" style="display: none;">Limpar Arquivos</button>
            
            <div class="file-preview" id="filePreview" style="display: none;">
                <h3>Pr√©-visualiza√ß√£o dos Arquivos</h3>
                <div class="file-tabs" id="fileTabs"></div>
                <div id="previewContainers"></div>
            </div>
        </div>
        
        <div class="card" id="configCard" style="display: none;">
            <h2 class="card-title">Configura√ß√µes de Compara√ß√£o</h2>
            
            <div class="comparison-info">
                <p><strong>Como funciona:</strong> Selecione as colunas que deseja comparar em cada arquivo. 
                O sistema ir√° comparar os <strong>conjuntos de valores</strong> das colunas selecionadas entre todos os arquivos, 
                independente da ordem das colunas.</p>
                <p><strong>Filtro autom√°tico:</strong> Apenas correspond√™ncias com 80% ou mais de similaridade ser√£o consideradas.</p>
            </div>

            <!-- Painel de Atalhos -->
            <div class="keyboard-shortcuts">
                <h4>‚å®Ô∏è Atalhos de Teclado:</h4>
                <div class="shortcut-item">
                    <span>Ctrl + 1-9</span>
                    <span>Alternar entre abas de arquivos</span>
                </div>
                <div class="shortcut-item">
                    <span>Ctrl + Enter</span>
                    <span>Iniciar compara√ß√£o</span>
                </div>
                <div class="shortcut-item">
                    <span>Esc</span>
                    <span>Limpar sele√ß√£o</span>
                </div>
            </div>
            
            <div class="config-section">
                <div class="form-group">
                    <label for="searchType">
                        Tipo de Busca 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">
                                <strong>Busca Exata:</strong> Valores devem ser id√™nticos<br>
                                <strong>Busca por Similaridade:</strong> Encontra valores similares (recomendado)
                            </span>
                        </span>
                    </label>
                    <select id="searchType">
                        <option value="exact">Busca Exata</option>
                        <option value="similar" selected>Busca por Similaridade</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="similarityThreshold">
                        Limiar de Similaridade M√≠nima (%) 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">
                                Define o percentual m√≠nimo de similaridade para considerar uma correspond√™ncia.
                                Valores mais altos = menos falsos positivos, mas podem perder algumas correspond√™ncias.
                            </span>
                        </span>
                    </label>
                    <input type="number" id="similarityThreshold" min="80" max="100" value="80">
                    <small style="color: #666;">M√≠nimo: 80% (apenas alta correspond√™ncia)</small>
                </div>
            </div>
            
            <div class="form-group">
                <label>Sele√ß√£o de Colunas por Arquivo</label>
                <div class="column-tabs" id="columnTabs"></div>
                <div id="columnContainers"></div>
                <p class="column-info">Selecione as colunas que deseja comparar em cada arquivo.</p>
            </div>

            <!-- Configura√ß√µes Salvas -->
            <div class="settings-panel" id="savedSettingsPanel" style="display: none;">
                <h4>‚öôÔ∏è Configura√ß√µes Salvas</h4>
                <select id="savedSettingsSelect" style="width: 100%; margin-bottom: 10px;">
                    <option value="">-- Selecione uma configura√ß√£o salva --</option>
                </select>
                <div>
                    <button class="btn" id="loadSettingsBtn" style="display: none;">Carregar Configura√ß√£o</button>
                    <button class="btn btn-success" id="saveSettingsBtn">Salvar Configura√ß√£o</button>
                    <button class="btn btn-danger" id="deleteSettingsBtn" style="display: none;">Excluir Configura√ß√£o</button>
                </div>
            </div>
            
            <button class="btn btn-success" id="compareBtn">Iniciar Compara√ß√£o (Ctrl+Enter)</button>
        </div>
        
        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <p>Processando arquivos e encontrando semelhan√ßas...</p>
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <p id="progressText">0%</p>
        </div>
        
        <div class="card results-section" id="resultsSection">
            <h2 class="card-title">Resultados da Compara√ß√£o</h2>
            
            <div class="summary-stats" id="summaryStats"></div>
            
            <div class="results-tabs" id="resultsTabs">
                <div class="results-tab active" data-tab="matches">Correspond√™ncias (80%+)</div>
                <div class="results-tab" data-tab="file1-only">Apenas no Arquivo 1</div>
                <div class="results-tab" data-tab="file2-only">Apenas no Arquivo 2</div>
            </div>
            
            <div id="resultsContainers">
                <div class="results-container active" id="matches-container">
                    <div class="pagination" id="matchesPagination"></div>
                </div>
                <div class="results-container" id="file1-only-container">
                    <div class="pagination" id="file1Pagination"></div>
                </div>
                <div class="results-container" id="file2-only-container">
                    <div class="pagination" id="file2Pagination"></div>
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn btn-success" id="exportMatchesBtn" style="display: none;">Exportar Correspond√™ncias</button>
                <button class="btn btn-warning" id="exportFile1OnlyBtn" style="display: none;">Exportar Apenas Arquivo 1</button>
                <button class="btn btn-warning" id="exportFile2OnlyBtn" style="display: none;">Exportar Apenas Arquivo 2</button>
                <button class="btn" id="exportAllBtn" style="display: none;">Exportar Relat√≥rio Completo</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Comparador de Arquivos Excel &copy; 2025 - Encontre semelhan√ßas entre seus dados</p>
    </footer>

    <script>
        // Vari√°veis globais
        let uploadedFiles = [];
        let fileData = [];
        let selectedColumnsByFile = {};
        let comparisonResults = {};
        let currentPage = {
            matches: 1,
            'file1-only': 1,
            'file2-only': 1
        };
        const pageSize = 50;
        let savedSettings = JSON.parse(localStorage.getItem('excelComparatorSettings') || '{}');
        
        // Elementos DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const fileList = document.getElementById('fileList');
        const filePreview = document.getElementById('filePreview');
        const fileTabs = document.getElementById('fileTabs');
        const previewContainers = document.getElementById('previewContainers');
        const clearFilesBtn = document.getElementById('clearFiles');
        const configCard = document.getElementById('configCard');
        const columnTabs = document.getElementById('columnTabs');
        const columnContainers = document.getElementById('columnContainers');
        const searchType = document.getElementById('searchType');
        const similarityThreshold = document.getElementById('similarityThreshold');
        const compareBtn = document.getElementById('compareBtn');
        const loadingSection = document.getElementById('loadingSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const summaryStats = document.getElementById('summaryStats');
        const resultsTabs = document.getElementById('resultsTabs');
        const matchesContainer = document.getElementById('matches-container');
        const file1OnlyContainer = document.getElementById('file1-only-container');
        const file2OnlyContainer = document.getElementById('file2-only-container');
        const exportAllBtn = document.getElementById('exportAllBtn');
        const exportMatchesBtn = document.getElementById('exportMatchesBtn');
        const exportFile1OnlyBtn = document.getElementById('exportFile1OnlyBtn');
        const exportFile2OnlyBtn = document.getElementById('exportFile2OnlyBtn');
        const errorMessage = document.getElementById('errorMessage');
        const savedSettingsPanel = document.getElementById('savedSettingsPanel');
        const savedSettingsSelect = document.getElementById('savedSettingsSelect');
        const loadSettingsBtn = document.getElementById('loadSettingsBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const deleteSettingsBtn = document.getElementById('deleteSettingsBtn');

        // Event Listeners
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        clearFilesBtn.addEventListener('click', clearFiles);
        searchType.addEventListener('change', toggleSimilarityThreshold);
        compareBtn.addEventListener('click', startComparison);
        saveSettingsBtn.addEventListener('click', saveCurrentSettings);
        loadSettingsBtn.addEventListener('click', loadSelectedSettings);
        deleteSettingsBtn.addEventListener('click', deleteSelectedSettings);
        savedSettingsSelect.addEventListener('change', updateSettingsButtons);

        // Atalhos de teclado
        document.addEventListener('keydown', handleKeyboardShortcuts);

        // Drag and Drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // Inicializar configura√ß√µes salvas
        initializeSavedSettings();

        // FUN√á√ïES DE SIMILARIDADE MELHORADAS
        function calculateSimilarity(str1, str2) {
            // Primeiro, verifica se s√£o exatamente iguais
            if (str1 === str2) return 1;
            
            // Remove espa√ßos extras e normaliza
            const cleanStr1 = str1.toString().trim();
            const cleanStr2 = str2.toString().trim();
            
            // Tenta comparar como n√∫meros (incluindo decimais e porcentagens)
            const num1 = parseNumber(cleanStr1);
            const num2 = parseNumber(cleanStr2);
            
            if (!isNaN(num1) && !isNaN(num2)) {
                // Se ambos s√£o n√∫meros v√°lidos, calcula similaridade num√©rica
                return calculateNumericSimilarity(num1, num2);
            }
            
            // Se n√£o s√£o n√∫meros, usa similaridade textual
            return calculateTextSimilarity(cleanStr1, cleanStr2);
        }
        
        function parseNumber(str) {
            // Remove caracteres n√£o num√©ricos, exceto ponto, v√≠rgula e sinal de porcentagem
            let cleanStr = str.replace(/[^\d,.%\-]/g, '');
            
            // Se termina com %, trata como porcentagem
            const isPercentage = cleanStr.endsWith('%');
            if (isPercentage) {
                cleanStr = cleanStr.replace('%', '');
            }
            
            // Substitui v√≠rgula por ponto para parseFloat
            cleanStr = cleanStr.replace(',', '.');
            
            // Remove m√∫ltiplos pontos decimais
            const parts = cleanStr.split('.');
            if (parts.length > 2) {
                cleanStr = parts[0] + '.' + parts.slice(1).join('');
            }
            
            const num = parseFloat(cleanStr);
            
            // Se era porcentagem, converte para decimal
            if (isPercentage && !isNaN(num)) {
                return num / 100;
            }
            
            return num;
        }
        
        function calculateNumericSimilarity(num1, num2) {
            // Se s√£o exatamente iguais
            if (num1 === num2) return 1;
            
            // Se um dos n√∫meros √© zero, cuidado com divis√£o por zero
            if (num1 === 0 || num2 === 0) {
                return (num1 === num2) ? 1 : 0;
            }
            
            // Calcula a diferen√ßa relativa
            const diff = Math.abs(num1 - num2);
            const avg = (Math.abs(num1) + Math.abs(num2)) / 2;
            
            // Similaridade baseada na diferen√ßa relativa
            const relativeDiff = diff / avg;
            
            // Para n√∫meros muito pr√≥ximos, considera alta similaridade
            if (relativeDiff < 0.01) { // 1% de diferen√ßa
                return 0.95;
            } else if (relativeDiff < 0.05) { // 5% de diferen√ßa
                return 0.85;
            } else if (relativeDiff < 0.1) { // 10% de diferen√ßa
                return 0.7;
            } else if (relativeDiff < 0.2) { // 20% de diferen√ßa
                return 0.5;
            }
            
            return 0;
        }
        
        function calculateTextSimilarity(str1, str2) {
            const normalize = (str) => {
                if (!str) return '';
                return str.toString()
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '') // remove acentos
                    .replace(/[^\w\s]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            };
            
            const normStr1 = normalize(str1);
            const normStr2 = normalize(str2);
            
            if (normStr1 === normStr2) return 1;
            
            // Verifica se uma string cont√©m a outra
            if (normStr1.includes(normStr2) || normStr2.includes(normStr1)) {
                const longer = Math.max(normStr1.length, normStr2.length);
                const shorter = Math.min(normStr1.length, normStr2.length);
                return shorter / longer;
            }
            
            // Similaridade por Jaro-Winkler (melhor para nomes pr√≥prios)
            return jaroWinklerSimilarity(normStr1, normStr2);
        }
        
        function jaroWinklerSimilarity(s1, s2) {
            if (s1 === s2) return 1;
            
            const m = matchingCharacters(s1, s2);
            if (m === 0) return 0;
            
            const t = transpositions(s1, s2, m);
            const j = ((m / s1.length) + (m / s2.length) + ((m - t) / m)) / 3;
            
            // Winkler modification: boost for common prefix
            let prefix = 0;
            const maxPrefix = Math.min(4, s1.length, s2.length);
            for (let i = 0; i < maxPrefix; i++) {
                if (s1[i] === s2[i]) prefix++;
                else break;
            }
            
            return j + (prefix * 0.1 * (1 - j));
        }
        
        function matchingCharacters(s1, s2) {
            const maxDistance = Math.floor(Math.max(s1.length, s2.length) / 2) - 1;
            let matches = 0;
            const matched2 = new Array(s2.length).fill(false);
            
            for (let i = 0; i < s1.length; i++) {
                const start = Math.max(0, i - maxDistance);
                const end = Math.min(i + maxDistance + 1, s2.length);
                
                for (let j = start; j < end; j++) {
                    if (!matched2[j] && s1[i] === s2[j]) {
                        matches++;
                        matched2[j] = true;
                        break;
                    }
                }
            }
            
            return matches;
        }
        
        function transpositions(s1, s2, matches) {
            if (matches === 0) return 0;
            
            let transpositions = 0;
            let k = 0;
            const maxDistance = Math.floor(Math.max(s1.length, s2.length) / 2) - 1;
            const matched2 = new Array(s2.length).fill(false);
            
            for (let i = 0; i < s1.length; i++) {
                const start = Math.max(0, i - maxDistance);
                const end = Math.min(i + maxDistance + 1, s2.length);
                
                for (let j = start; j < end; j++) {
                    if (!matched2[j] && s1[i] === s2[j]) {
                        if (i !== k && j !== k) transpositions++;
                        matched2[j] = true;
                        k++;
                        break;
                    }
                }
            }
            
            return transpositions / 2;
        }

        function calculateSetSimilarity(values1, values2, isExactSearch) {
            if (values1.length === 0 && values2.length === 0) return 1;
            if (values1.length === 0 || values2.length === 0) return 0;
            
            // Para busca exata, usa compara√ß√£o direta
            if (isExactSearch) {
                const set1 = new Set(values1);
                const set2 = new Set(values2);
                const intersection = new Set([...set1].filter(x => set2.has(x)));
                const union = new Set([...set1, ...set2]);
                return union.size === 0 ? 1 : intersection.size / union.size;
            }
            
            // Para busca por similaridade, usa algoritmo melhorado
            let totalSimilarity = 0;
            const usedIndexes = new Set();
            
            // Para cada valor no primeiro conjunto, encontra a melhor correspond√™ncia no segundo
            values1.forEach((val1, i) => {
                let bestSimilarity = 0;
                let bestIndex = -1;
                
                values2.forEach((val2, j) => {
                    if (usedIndexes.has(j)) return;
                    
                    const similarity = calculateSimilarity(val1, val2);
                    
                    if (similarity > bestSimilarity) {
                        bestSimilarity = similarity;
                        bestIndex = j;
                    }
                });
                
                if (bestIndex !== -1 && bestSimilarity > 0.6) { // Limiar mais baixo para matching individual
                    totalSimilarity += bestSimilarity;
                    usedIndexes.add(bestIndex);
                }
            });
            
            // Calcula similaridade m√©dia ponderada
            const maxPossibleMatches = Math.max(values1.length, values2.length);
            return maxPossibleMatches > 0 ? totalSimilarity / maxPossibleMatches : 0;
        }

        // NOVAS FUN√á√ïES ADICIONADAS
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (compareBtn.style.display !== 'none') {
                            startComparison();
                        }
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                    case '6':
                    case '7':
                    case '8':
                    case '9':
                        e.preventDefault();
                        const index = parseInt(e.key) - 1;
                        if (index < fileData.length) {
                            activateTab(index);
                            activateColumnTab(index);
                        }
                        break;
                }
            } else if (e.key === 'Escape') {
                clearFiles();
            }
        }

        function initializeSavedSettings() {
            if (Object.keys(savedSettings).length > 0) {
                savedSettingsPanel.style.display = 'block';
                updateSavedSettingsSelect();
            }
        }

        function updateSavedSettingsSelect() {
            savedSettingsSelect.innerHTML = '<option value="">-- Selecione uma configura√ß√£o salva --</option>';
            Object.keys(savedSettings).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                savedSettingsSelect.appendChild(option);
            });
        }

        function updateSettingsButtons() {
            const selected = savedSettingsSelect.value;
            loadSettingsBtn.style.display = selected ? 'inline-block' : 'none';
            deleteSettingsBtn.style.display = selected ? 'inline-block' : 'none';
        }

        function saveCurrentSettings() {
            const settingsName = prompt('Digite um nome para esta configura√ß√£o:');
            if (!settingsName) return;

            const settings = {
                searchType: searchType.value,
                similarityThreshold: similarityThreshold.value,
                selectedColumns: {...selectedColumnsByFile}
            };

            savedSettings[settingsName] = settings;
            localStorage.setItem('excelComparatorSettings', JSON.stringify(savedSettings));
            
            savedSettingsPanel.style.display = 'block';
            updateSavedSettingsSelect();
            savedSettingsSelect.value = settingsName;
            updateSettingsButtons();
            
            alert(`Configura√ß√£o "${settingsName}" salva com sucesso!`);
        }

        function loadSelectedSettings() {
            const settingsName = savedSettingsSelect.value;
            if (!settingsName) return;

            const settings = savedSettings[settingsName];
            if (!settings) return;

            searchType.value = settings.searchType;
            similarityThreshold.value = settings.similarityThreshold;
            
            // Aplicar sele√ß√£o de colunas
            if (settings.selectedColumns) {
                selectedColumnsByFile = {...settings.selectedColumns};
                updateCheckboxesFromSettings();
            }

            toggleSimilarityThreshold();
            alert(`Configura√ß√£o "${settingsName}" carregada com sucesso!`);
        }

        function deleteSelectedSettings() {
            const settingsName = savedSettingsSelect.value;
            if (!settingsName || !confirm(`Tem certeza que deseja excluir a configura√ß√£o "${settingsName}"?`)) return;

            delete savedSettings[settingsName];
            localStorage.setItem('excelComparatorSettings', JSON.stringify(savedSettings));
            
            updateSavedSettingsSelect();
            updateSettingsButtons();
            
            if (Object.keys(savedSettings).length === 0) {
                savedSettingsPanel.style.display = 'none';
            }
        }

        function updateCheckboxesFromSettings() {
            Object.keys(selectedColumnsByFile).forEach(fileIndex => {
                const container = document.getElementById(`column-${fileIndex}`);
                if (!container) return;

                const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([id^="select-all-"])');
                const selectedCols = selectedColumnsByFile[fileIndex] || [];

                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectedCols.includes(checkbox.value);
                });

                const selectAllCheckbox = document.getElementById(`select-all-${fileIndex}`);
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = selectedCols.length === checkboxes.length;
                }
            });
        }

        function updateProgress(percent) {
            progressBar.style.width = percent + '%';
            progressText.textContent = percent + '%';
        }

        function simulateProgress() {
            let width = 0;
            const interval = setInterval(() => {
                width += 5;
                updateProgress(width);
                
                if (width >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        loadingSection.style.display = 'none';
                        performComparison();
                    }, 500);
                }
            }, 100);
        }

        function getPaginatedData(data, page, pageSize) {
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            return data.slice(start, end);
        }

        function createPagination(totalItems, currentPage, pageSize, containerId, type) {
            const totalPages = Math.ceil(totalItems / pageSize);
            if (totalPages <= 1) return '';

            let paginationHTML = '<div class="pagination">';
            
            // Bot√£o anterior
            if (currentPage > 1) {
                paginationHTML += `<button onclick="changePage('${type}', ${currentPage - 1})">&laquo; Anterior</button>`;
            }

            // P√°ginas
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button onclick="changePage('${type}', ${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<span>...</span>';
                }
            }

            // Bot√£o pr√≥ximo
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="changePage('${type}', ${currentPage + 1})">Pr√≥ximo &raquo;</button>`;
            }

            paginationHTML += `</div><div style="text-align: center; margin-top: 10px; color: #666;">
                P√°gina ${currentPage} de ${totalPages} - Total: ${totalItems} itens
            </div>`;

            return paginationHTML;
        }

        function changePage(type, page) {
            currentPage[type] = page;
            
            switch(type) {
                case 'matches':
                    showMatches();
                    break;
                case 'file1-only':
                    showFile1Only();
                    break;
                case 'file2-only':
                    showFile2Only();
                    break;
            }
        }

        // FUN√á√ïES EXISTENTES (com algumas modifica√ß√µes)
        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            errorMessage.style.display = 'none';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    showError(`O arquivo "${file.name}" n√£o √© um arquivo Excel v√°lido.`);
                    continue;
                }
                
                if (uploadedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    showError(`O arquivo "${file.name}" j√° foi adicionado.`);
                    continue;
                }
                
                uploadedFiles.push(file);
                addFileToList(file);
            }
            
            if (uploadedFiles.length > 0) {
                clearFilesBtn.style.display = 'inline-block';
                configCard.style.display = 'block';
            }
            
            fileInput.value = '';
            processFilesForColumns();
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function addFileToList(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileInfo = document.createElement('div');
            fileInfo.innerHTML = `
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
            `;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-danger';
            removeBtn.textContent = 'Remover';
            removeBtn.addEventListener('click', () => removeFile(file));
            
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(removeBtn);
            fileList.appendChild(fileItem);
        }
        
        function removeFile(fileToRemove) {
            uploadedFiles = uploadedFiles.filter(file => file !== fileToRemove);
            fileList.innerHTML = '';
            
            uploadedFiles.forEach(file => addFileToList(file));
            
            if (uploadedFiles.length === 0) {
                clearFilesBtn.style.display = 'none';
                configCard.style.display = 'none';
                filePreview.style.display = 'none';
            } else {
                processFilesForColumns();
            }
        }
        
        function clearFiles() {
            uploadedFiles = [];
            fileList.innerHTML = '';
            clearFilesBtn.style.display = 'none';
            configCard.style.display = 'none';
            filePreview.style.display = 'none';
            resultsSection.style.display = 'none';
            selectedColumnsByFile = {};
            errorMessage.style.display = 'none';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function toggleSimilarityThreshold() {
            similarityThreshold.disabled = searchType.value === 'exact';
        }
        
        function processFilesForColumns() {
            if (uploadedFiles.length === 0) return;
            
            fileData = [];
            let processedCount = 0;
            
            fileTabs.innerHTML = '';
            previewContainers.innerHTML = '';
            filePreview.style.display = 'block';
            
            columnTabs.innerHTML = '';
            columnContainers.innerHTML = '';
            selectedColumnsByFile = {};
            
            uploadedFiles.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        const fileInfo = {
                            name: file.name,
                            data: jsonData,
                            headers: jsonData[0] || []
                        };
                        
                        fileData.push(fileInfo);
                        addFilePreview(file.name, jsonData, index);
                        addColumnSelection(file.name, fileInfo.headers, index);
                        
                        processedCount++;
                        
                        if (processedCount === uploadedFiles.length) {
                            activateTab(0);
                            activateColumnTab(0);
                        }
                    } catch (error) {
                        console.error('Erro ao processar arquivo:', error);
                        showError(`Erro ao processar o arquivo "${file.name}". Verifique se √© um arquivo Excel v√°lido.`);
                    }
                };
                
                reader.onerror = function() {
                    showError(`Erro ao ler o arquivo: ${file.name}`);
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        function addFilePreview(fileName, data, index) {
            const tab = document.createElement('div');
            tab.className = 'file-tab';
            tab.textContent = fileName;
            tab.dataset.index = index;
            tab.addEventListener('click', () => activateTab(index));
            fileTabs.appendChild(tab);
            
            const container = document.createElement('div');
            container.className = 'preview-container';
            container.id = `preview-${index}`;
            
            let tableHTML = `<table class="preview-table"><thead><tr>`;
            
            if (data.length > 0 && data[0]) {
                data[0].forEach(header => {
                    tableHTML += `<th>${header || ''}</th>`;
                });
                tableHTML += `</tr></thead><tbody>`;
                
                const rowCount = Math.min(data.length, 11);
                for (let i = 1; i < rowCount; i++) {
                    if (data[i]) {
                        tableHTML += `<tr>`;
                        data[i].forEach(cell => {
                            tableHTML += `<td>${cell || ''}</td>`;
                        });
                        tableHTML += `</tr>`;
                    }
                }
                
                tableHTML += `</tbody></table>`;
                
                if (data.length > 10) {
                    tableHTML += `<p style="margin-top: 10px; font-style: italic;">Mostrando 10 de ${data.length-1} linhas</p>`;
                }
            } else {
                tableHTML = '<p>Arquivo vazio ou sem dados</p>';
            }
            
            container.innerHTML = tableHTML;
            previewContainers.appendChild(container);
        }
        
        function addColumnSelection(fileName, headers, index) {
            const tab = document.createElement('div');
            tab.className = 'column-tab';
            tab.textContent = fileName;
            tab.dataset.index = index;
            tab.addEventListener('click', () => activateColumnTab(index));
            columnTabs.appendChild(tab);
            
            const container = document.createElement('div');
            container.className = 'column-container';
            container.id = `column-${index}`;
            
            const validHeaders = headers.filter(header => header && header.toString().trim() !== '');
            
            if (validHeaders.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #c0392b;">Nenhuma coluna v√°lida encontrada neste arquivo.</p>';
            } else {
                const selectAllContainer = document.createElement('div');
                selectAllContainer.className = 'select-all-container';
                
                const selectAllGroup = document.createElement('div');
                selectAllGroup.className = 'checkbox-group';
                
                const selectAllCheckbox = document.createElement('input');
                selectAllCheckbox.type = 'checkbox';
                selectAllCheckbox.id = `select-all-${index}`;
                selectAllCheckbox.checked = true;
                selectAllCheckbox.addEventListener('change', function() {
                    const container = document.getElementById(`column-${index}`);
                    if (!container) return;
                    
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([id^="select-all-"])');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateSelectedColumnsForFile(index);
                });
                
                const selectAllLabel = document.createElement('label');
                selectAllLabel.htmlFor = `select-all-${index}`;
                selectAllLabel.textContent = 'Selecionar Todas as Colunas';
                selectAllLabel.style.fontWeight = 'bold';
                
                selectAllGroup.appendChild(selectAllCheckbox);
                selectAllGroup.appendChild(selectAllLabel);
                selectAllContainer.appendChild(selectAllGroup);
                container.appendChild(selectAllContainer);
                
                const columnsContainer = document.createElement('div');
                columnsContainer.className = 'column-selection-container';
                
                validHeaders.forEach(header => {
                    const checkboxGroup = document.createElement('div');
                    checkboxGroup.className = 'checkbox-group';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `col-${index}-${header.replace(/\s+/g, '-')}`;
                    checkbox.value = header;
                    checkbox.checked = true;
                    checkbox.addEventListener('change', () => updateSelectedColumnsForFile(index));
                    
                    const label = document.createElement('label');
                    label.htmlFor = `col-${index}-${header.replace(/\s+/g, '-')}`;
                    label.textContent = header;
                    
                    checkboxGroup.appendChild(checkbox);
                    checkboxGroup.appendChild(label);
                    columnsContainer.appendChild(checkboxGroup);
                });
                
                container.appendChild(columnsContainer);
                updateSelectedColumnsForFile(index);
            }
            
            columnContainers.appendChild(container);
        }
        
        function activateTab(index) {
            document.querySelectorAll('.file-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.preview-container').forEach(container => {
                container.classList.remove('active');
            });
            
            const tab = document.querySelector(`.file-tab[data-index="${index}"]`);
            const container = document.getElementById(`preview-${index}`);
            
            if (tab) tab.classList.add('active');
            if (container) container.classList.add('active');
        }
        
        function activateColumnTab(index) {
            document.querySelectorAll('.column-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.column-container').forEach(container => {
                container.classList.remove('active');
            });
            
            const tab = document.querySelector(`.column-tab[data-index="${index}"]`);
            const container = document.getElementById(`column-${index}`);
            
            if (tab) tab.classList.add('active');
            if (container) container.classList.add('active');
        }
        
        function updateSelectedColumnsForFile(fileIndex) {
            const container = document.getElementById(`column-${fileIndex}`);
            if (!container) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([id^="select-all-"])');
            const selectedColumns = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedColumns.push(checkbox.value);
                }
            });
            
            selectedColumnsByFile[fileIndex] = selectedColumns;
            
            const selectAllCheckbox = document.getElementById(`select-all-${fileIndex}`);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedColumns.length === checkboxes.length;
            }
        }
        
        function startComparison() {
            if (uploadedFiles.length < 2) {
                showError('Por favor, fa√ßa upload de pelo menos 2 arquivos para comparar.');
                return;
            }
            
            for (let i = 0; i < fileData.length; i++) {
                if (!selectedColumnsByFile[i] || selectedColumnsByFile[i].length === 0) {
                    showError(`Por favor, selecione pelo menos uma coluna no arquivo "${fileData[i].name}".`);
                    activateColumnTab(i);
                    return;
                }
            }
            
            loadingSection.style.display = 'block';
            resultsSection.style.display = 'none';
            updateProgress(0);
            
            setTimeout(() => {
                simulateProgress();
            }, 500);
        }
        
        function filterHighConfidenceMatches(matches, threshold = 0.8) {
            return matches.filter(match => match.similarity >= threshold * 100);
        }
        
        function performComparison() {
            comparisonResults = {
                exactMatches: [],
                file1Only: [],
                file2Only: []
            };
            
            const isExactSearch = searchType.value === 'exact';
            const threshold = parseInt(similarityThreshold.value) / 100;
            
            if (fileData.length >= 2) {
                const file1 = fileData[0];
                const file2 = fileData[1];
                compareCompleteRows(file1, file2, isExactSearch, threshold);
            }
            
            comparisonResults.exactMatches = filterHighConfidenceMatches(comparisonResults.exactMatches, 0.8);
            
            showResults();
        }
        
        function compareCompleteRows(file1, file2, isExactSearch, threshold) {
            const file1Rows = [];
            const file2Rows = [];
            
            // Preparar linhas do arquivo 1
            for (let row1 = 1; row1 < file1.data.length; row1++) {
                if (!file1.data[row1]) continue;
                
                const rowValues = [];
                const rowData = {};
                
                selectedColumnsByFile[0].forEach(column => {
                    const colIndex = file1.headers.indexOf(column);
                    if (colIndex !== -1 && file1.data[row1][colIndex] !== undefined) {
                        const value = file1.data[row1][colIndex];
                        if (value !== null && value !== '' && value !== undefined) {
                            rowValues.push(value.toString().trim());
                            rowData[column] = value;
                        }
                    }
                });
                
                file1Rows.push({
                    rowIndex: row1,
                    values: rowValues,
                    rowData: rowData,
                    fullRow: file1.data[row1]
                });
            }
            
            // Preparar linhas do arquivo 2
            for (let row2 = 1; row2 < file2.data.length; row2++) {
                if (!file2.data[row2]) continue;
                
                const rowValues = [];
                const rowData = {};
                
                selectedColumnsByFile[1].forEach(column => {
                    const colIndex = file2.headers.indexOf(column);
                    if (colIndex !== -1 && file2.data[row2][colIndex] !== undefined) {
                        const value = file2.data[row2][colIndex];
                        if (value !== null && value !== '' && value !== undefined) {
                            rowValues.push(value.toString().trim());
                            rowData[column] = value;
                        }
                    }
                });
                
                file2Rows.push({
                    rowIndex: row2,
                    values: rowValues,
                    rowData: rowData,
                    fullRow: file2.data[row2]
                });
            }
            
            const matchedFile2Rows = new Set();
            
            file1Rows.forEach((row1, row1Index) => {
                let bestMatch = null;
                let bestSimilarity = 0;
                
                file2Rows.forEach((row2, row2Index) => {
                    if (matchedFile2Rows.has(row2Index)) return;
                    
                    const similarity = calculateSetSimilarity(row1.values, row2.values, isExactSearch);
                    
                    if (similarity >= 0.8 && similarity > bestSimilarity) {
                        bestSimilarity = similarity;
                        bestMatch = { 
                            row2, 
                            row2Index,
                            similarity: similarity
                        };
                    }
                });
                
                if (bestMatch && bestSimilarity >= 0.8) {
                    comparisonResults.exactMatches.push({
                        file1: file1.name,
                        row1: row1.rowIndex,
                        file2: file2.name,
                        row2: bestMatch.row2.rowIndex,
                        similarity: Math.round(bestMatch.similarity * 100),
                        row1Data: row1.rowData,
                        row2Data: bestMatch.row2.rowData,
                        fullRow1: row1.fullRow,
                        fullRow2: bestMatch.row2.fullRow
                    });
                    
                    matchedFile2Rows.add(bestMatch.row2Index);
                } else {
                    comparisonResults.file1Only.push({
                        file: file1.name,
                        row: row1.rowIndex,
                        rowData: row1.rowData,
                        fullRow: row1.fullRow
                    });
                }
            });
            
            file2Rows.forEach((row2, row2Index) => {
                if (!matchedFile2Rows.has(row2Index)) {
                    comparisonResults.file2Only.push({
                        file: file2.name,
                        row: row2.rowIndex,
                        rowData: row2.rowData,
                        fullRow: row2.fullRow
                    });
                }
            });
        }
        
        function showResults() {
            resultsSection.style.display = 'block';
            setupResultsTabs();
            showSummaryStats();
            showMatches();
            showFile1Only();
            showFile2Only();
            showExportButtons();
        }
        
        function setupResultsTabs() {
            const tabs = document.querySelectorAll('.results-tab');
            const containers = document.querySelectorAll('.results-container');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    containers.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tabName}-container`).classList.add('active');
                });
            });
        }
        
        function showSummaryStats() {
            const statsHTML = `
                <div class="stat-card match">
                    <div class="stat-value">${comparisonResults.exactMatches.length}</div>
                    <div class="stat-label">Correspond√™ncias (80%+)</div>
                </div>
                <div class="stat-card file1-only">
                    <div class="stat-value">${comparisonResults.file1Only.length}</div>
                    <div class="stat-label">Apenas no Arquivo 1</div>
                </div>
                <div class="stat-card file2-only">
                    <div class="stat-value">${comparisonResults.file2Only.length}</div>
                    <div class="stat-label">Apenas no Arquivo 2</div>
                </div>
            `;
            
            summaryStats.innerHTML = statsHTML;
        }
        
        function showMatches() {
            if (comparisonResults.exactMatches.length === 0) {
                matchesContainer.innerHTML = '<div class="no-results"><p>Nenhuma correspond√™ncia com 80% ou mais de similaridade encontrada.</p></div>';
                return;
            }
            
            const selectedCols1 = selectedColumnsByFile[0] || [];
            const selectedCols2 = selectedColumnsByFile[1] || [];
            const paginatedData = getPaginatedData(comparisonResults.exactMatches, currentPage.matches, pageSize);
            
            let tableHTML = `
                <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Similaridade</th>
                            <th>Arquivo 1 - Linha</th>
                            <th>Arquivo 2 - Linha</th>
            `;
            
            // Cabe√ßalhos das colunas selecionadas - mostrando ambas as vers√µes
            selectedCols1.forEach((col, index) => {
                const col2 = selectedCols2[index] || col;
                tableHTML += `<th>${col} (Arq1) ‚Üî ${col2} (Arq2)</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            paginatedData.forEach(match => {
                const similarityClass = 'high-similarity';
                
                tableHTML += `
                    <tr class="match-row comparison-row">
                        <td class="${similarityClass}">${match.similarity}%</td>
                        <td>${match.row1 + 1}</td>
                        <td>${match.row2 + 1}</td>
                `;
                
                // Dados das colunas selecionadas - mostrando ambos os valores
                selectedCols1.forEach((col, index) => {
                    const col2 = selectedCols2[index] || col;
                    const value1 = match.row1Data[col] || '';
                    const value2 = match.row2Data[col2] || '';
                    
                    tableHTML += `<td>
                        <strong>Arq1:</strong> ${value1}<br>
                        <strong>Arq2:</strong> ${value2}
                    </td>`;
                });
                
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            
            const paginationHTML = createPagination(
                comparisonResults.exactMatches.length, 
                currentPage.matches, 
                pageSize, 
                'matchesPagination', 
                'matches'
            );
            
            matchesContainer.innerHTML = tableHTML + paginationHTML;
        }
        
        function showFile1Only() {
            if (comparisonResults.file1Only.length === 0) {
                file1OnlyContainer.innerHTML = '<div class="no-results"><p>Nenhuma linha encontrada apenas no Arquivo 1.</p></div>';
                return;
            }
            
            const selectedCols = selectedColumnsByFile[0] || [];
            const paginatedData = getPaginatedData(comparisonResults.file1Only, currentPage['file1-only'], pageSize);
            
            let tableHTML = `
                <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Linha</th>
            `;
            
            selectedCols.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            paginatedData.forEach(item => {
                tableHTML += `
                    <tr class="only-in-file1">
                        <td>${item.row + 1}</td>
                `;
                
                selectedCols.forEach(col => {
                    tableHTML += `<td>${item.rowData[col] || ''}</td>`;
                });
                
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            
            const paginationHTML = createPagination(
                comparisonResults.file1Only.length, 
                currentPage['file1-only'], 
                pageSize, 
                'file1Pagination', 
                'file1-only'
            );
            
            file1OnlyContainer.innerHTML = tableHTML + paginationHTML;
        }
        
        function showFile2Only() {
            if (comparisonResults.file2Only.length === 0) {
                file2OnlyContainer.innerHTML = '<div class="no-results"><p>Nenhuma linha encontrada apenas no Arquivo 2.</p></div>';
                return;
            }
            
            const selectedCols = selectedColumnsByFile[1] || [];
            const paginatedData = getPaginatedData(comparisonResults.file2Only, currentPage['file2-only'], pageSize);
            
            let tableHTML = `
                <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Linha</th>
            `;
            
            selectedCols.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            paginatedData.forEach(item => {
                tableHTML += `
                    <tr class="only-in-file2">
                        <td>${item.row + 1}</td>
                `;
                
                selectedCols.forEach(col => {
                    tableHTML += `<td>${item.rowData[col] || ''}</td>`;
                });
                
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            
            const paginationHTML = createPagination(
                comparisonResults.file2Only.length, 
                currentPage['file2-only'], 
                pageSize, 
                'file2Pagination', 
                'file2-only'
            );
            
            file2OnlyContainer.innerHTML = tableHTML + paginationHTML;
        }
        
        function showExportButtons() {
            exportMatchesBtn.style.display = 'inline-block';
            exportFile1OnlyBtn.style.display = 'inline-block';
            exportFile2OnlyBtn.style.display = 'inline-block';
            exportAllBtn.style.display = 'inline-block';
            
            exportMatchesBtn.onclick = () => exportToExcel('matches');
            exportFile1OnlyBtn.onclick = () => exportToExcel('file1-only');
            exportFile2OnlyBtn.onclick = () => exportToExcel('file2-only');
            exportAllBtn.onclick = () => exportToExcel('all');
        }
        
        function exportToExcel(type) {
            const wb = XLSX.utils.book_new();
            
            switch(type) {
                case 'matches':
                    if (comparisonResults.exactMatches.length > 0) {
                        const data = prepareMatchesData();
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        XLSX.utils.book_append_sheet(wb, ws, 'Correspondencias');
                        XLSX.writeFile(wb, 'correspondencias.xlsx');
                    } else {
                        alert('N√£o h√° correspond√™ncias para exportar.');
                    }
                    break;
                    
                case 'file1-only':
                    if (comparisonResults.file1Only.length > 0) {
                        const data = prepareFileOnlyData(comparisonResults.file1Only, 0);
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        XLSX.utils.book_append_sheet(wb, ws, 'Apenas_Arquivo1');
                        XLSX.writeFile(wb, 'apenas_arquivo1.xlsx');
                    } else {
                        alert('N√£o h√° linhas apenas no Arquivo 1 para exportar.');
                    }
                    break;
                    
                case 'file2-only':
                    if (comparisonResults.file2Only.length > 0) {
                        const data = prepareFileOnlyData(comparisonResults.file2Only, 1);
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        XLSX.utils.book_append_sheet(wb, ws, 'Apenas_Arquivo2');
                        XLSX.writeFile(wb, 'apenas_arquivo2.xlsx');
                    } else {
                        alert('N√£o h√° linhas apenas no Arquivo 2 para exportar.');
                    }
                    break;
                    
                case 'all':
                    exportAllSheets(wb);
                    XLSX.writeFile(wb, 'relatorio_completo.xlsx');
                    break;
            }
        }
        
        function prepareMatchesData() {
            const selectedCols1 = selectedColumnsByFile[0] || [];
            const selectedCols2 = selectedColumnsByFile[1] || [];
            
            const data = [
                ['CORRESPOND√äNCIAS ENCONTRADAS (80%+ Similaridade)'],
                [],
                ['Similaridade', 'Arquivo 1 - Linha', 'Arquivo 2 - Linha']
            ];
            
            // Adicionar cabe√ßalhos para as colunas selecionadas
            const headers = ['Similaridade', 'Arquivo 1 - Linha', 'Arquivo 2 - Linha'];
            selectedCols1.forEach((col, index) => {
                const col2 = selectedCols2[index] || col;
                headers.push(`${col} (Arq1)`);
                headers.push(`${col2} (Arq2)`);
            });
            data[2] = headers;
            
            comparisonResults.exactMatches.forEach(match => {
                const row = [
                    `${match.similarity}%`,
                    match.row1 + 1,
                    match.row2 + 1
                ];
                
                // Adicionar dados das colunas selecionadas
                selectedCols1.forEach((col, index) => {
                    const col2 = selectedCols2[index] || col;
                    const value1 = match.row1Data[col] || '';
                    const value2 = match.row2Data[col2] || '';
                    row.push(value1);
                    row.push(value2);
                });
                
                data.push(row);
            });
            
            return data;
        }
        
        function prepareFileOnlyData(items, fileIndex) {
            const selectedCols = selectedColumnsByFile[fileIndex] || [];
            const fileName = fileData[fileIndex].name;
            
            const data = [
                [`LINHAS APENAS NO ${fileName.toUpperCase()}`],
                [],
                ['Linha', ...selectedCols]
            ];
            
            items.forEach(item => {
                const row = [item.row + 1];
                
                selectedCols.forEach(col => {
                    row.push(item.rowData[col] || '');
                });
                
                data.push(row);
            });
            
            return data;
        }
        
        function exportAllSheets(wb) {
            let hasData = false;
            
            if (comparisonResults.exactMatches.length > 0) {
                const data = prepareMatchesData();
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Correspondencias');
                hasData = true;
            }
            
            if (comparisonResults.file1Only.length > 0) {
                const data = prepareFileOnlyData(comparisonResults.file1Only, 0);
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Apenas_Arquivo1');
                hasData = true;
            }
            
            if (comparisonResults.file2Only.length > 0) {
                const data = prepareFileOnlyData(comparisonResults.file2Only, 1);
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Apenas_Arquivo2');
                hasData = true;
            }
            
            if (!hasData) {
                alert('N√£o h√° dados para exportar.');
            }
        }
        
        // Inicializar
        toggleSimilarityThreshold();
    </script>
</body>
</html>
