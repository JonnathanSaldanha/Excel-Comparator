<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Arquivos Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .card-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }
        
        .upload-area {
            border: 2px dashed var(--secondary-color);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .upload-area:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .upload-area.dragover {
            background-color: rgba(52, 152, 219, 0.2);
            border-color: var(--primary-color);
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
            display: inline-block;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: var(--light-color);
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .file-name {
            font-weight: 600;
        }
        
        .file-size {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .config-section {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .column-selection-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
            margin-top: 10px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .checkbox-group:hover {
            background-color: #eef5ff;
        }
        
        .checkbox-group input {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .select-all-container {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .results-section {
            display: none;
        }
        
        .results-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .results-tab {
            padding: 12px 25px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            background-color: #f2f2f2;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .results-tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
            color: var(--primary-color);
        }
        
        .results-tab:hover:not(.active) {
            background-color: #e9e9e9;
        }
        
        .results-container {
            display: none;
        }
        
        .results-container.active {
            display: block;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem;
        }
        
        .results-table th, .results-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .results-table th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }
        
        .results-table tr:hover {
            background-color: #f1f8ff;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .match-row {
            background-color: rgba(46, 204, 113, 0.1);
        }
        
        .only-in-file1 {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .only-in-file2 {
            background-color: rgba(241, 196, 15, 0.1);
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .column-info {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .file-preview {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .preview-table th, .preview-table td {
            padding: 8px 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .preview-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        .preview-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .file-tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .file-tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            background-color: #f2f2f2;
        }
        
        .file-tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .preview-container {
            display: none;
        }
        
        .preview-container.active {
            display: block;
        }
        
        .column-tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .column-tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            background-color: #f2f2f2;
        }
        
        .column-tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .column-container {
            display: none;
        }
        
        .column-container.active {
            display: block;
        }
        
        .comparison-info {
            background-color: #e8f4fd;
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .error-message {
            background-color: #ffeaa7;
            border-left: 4px solid #fdcb6e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .stat-card.match {
            border-left-color: var(--success-color);
        }
        
        .stat-card.file1-only {
            border-left-color: var(--secondary-color);
        }
        
        .stat-card.file2-only {
            border-left-color: var(--warning-color);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .export-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .high-similarity {
            color: var(--success-color);
            font-weight: bold;
        }

        .comparison-row {
            border-left: 4px solid var(--success-color);
        }

        /* MELHORIAS DO PRIMEIRO ARQUIVO */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button.active {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .pagination button:hover:not(.active) {
            background-color: #f0f0f0;
        }

        .examples-section {
            background-color: #e8f6f3;
            border-left: 4px solid var(--success-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .performance-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .percentage-cell {
            background-color: #e8f5e8;
            font-weight: 600;
        }

        .order-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Comparador de Arquivos Excel</h1>
            <p class="subtitle">Encontre semelhan√ßas entre arquivos Excel, mesmo em linhas e colunas diferentes</p>
        </header>
        
        <div class="error-message" id="errorMessage"></div>
        
        <!-- Se√ß√£o de Exemplos (Melhoria do primeiro arquivo) -->
        <div class="examples-section">
            <h4>üí° Exemplos de Uso:</h4>
            <ul>
                <li><strong>Comparar listas de clientes</strong> de diferentes sistemas</li>
                <li><strong>Encontrar duplicatas</strong> em bases de dados diferentes</li>
                <li><strong>Reconciliar planilhas</strong> com formatos diferentes</li>
                <li><strong>Validar migra√ß√£o</strong> de dados entre sistemas</li>
                <li><strong>Comparar porcentagens e valores num√©ricos</strong> com diferentes formata√ß√µes</li>
            </ul>
        </div>

        <div class="card">
            <h2 class="card-title">Upload de Arquivos 
                <span class="tooltip">‚ÑπÔ∏è
                    <span class="tooltiptext">
                        Arraste ou selecione arquivos Excel (.xlsx, .xls). 
                        Voc√™ pode comparar m√∫ltiplos arquivos simultaneamente.
                    </span>
                </span>
            </h2>
            
            <div class="upload-area" id="uploadArea">
                <p>Arraste e solte seus arquivos Excel aqui ou</p>
                <button class="btn" id="browseBtn">Selecionar Arquivos</button>
                <input type="file" id="fileInput" class="file-input" multiple accept=".xlsx, .xls">
                <p class="file-types">Formatos suportados: .xlsx, .xls</p>
                <p class="performance-warning">
                    ‚ö†Ô∏è <strong>Dica:</strong> Para arquivos grandes (+10MB), considere dividir em partes menores para melhor performance.
                </p>
                <p class="order-warning">
                    üîÑ <strong>Importante:</strong> A ordem dos arquivos n√£o afeta mais os resultados. O sistema agora √© independente da ordem.
                </p>
            </div>
            
            <div class="file-list" id="fileList"></div>
            
            <button class="btn btn-danger" id="clearFiles" style="display: none;">Limpar Arquivos</button>
            
            <div class="file-preview" id="filePreview" style="display: none;">
                <h3>Pr√©-visualiza√ß√£o dos Arquivos</h3>
                <div class="file-tabs" id="fileTabs"></div>
                <div id="previewContainers"></div>
            </div>
        </div>
        
        <div class="card" id="configCard" style="display: none;">
            <h2 class="card-title">Configura√ß√µes de Compara√ß√£o</h2>
            
            <div class="comparison-info">
                <p><strong>Como funciona:</strong> Selecione as colunas que deseja comparar em cada arquivo. 
                O sistema ir√° comparar os <strong>conjuntos de valores</strong> das colunas selecionadas entre todos os arquivos, 
                independente da ordem das colunas.</p>
                <p><strong>Suporte a porcentagens:</strong> O sistema reconhece automaticamente valores como "25%", "0.25" e "25" como equivalentes.</p>
                <p><strong>Algoritmo melhorado:</strong> Agora os resultados s√£o consistentes independentemente da ordem dos arquivos.</p>
            </div>
            
            <div class="config-section">
                <div class="form-group">
                    <label for="searchType">
                        Tipo de Busca 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">
                                <strong>Busca Exata:</strong> Valores devem ser id√™nticos<br>
                                <strong>Busca por Similaridade:</strong> Encontra valores similares (recomendado)
                            </span>
                        </span>
                    </label>
                    <select id="searchType">
                        <option value="exact">Busca Exata</option>
                        <option value="similar" selected>Busca por Similaridade</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="similarityThreshold">
                        Limiar de Similaridade M√≠nima (%) 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">
                                Define o percentual m√≠nimo de similaridade para considerar uma correspond√™ncia.
                                Valores mais altos = menos falsos positivos, mas podem perder algumas correspond√™ncias.
                            </span>
                        </span>
                    </label>
                    <input type="number" id="similarityThreshold" min="50" max="100" value="80">
                    <small style="color: #666;">M√≠nimo: 50% - Recomendado: 80%</small>
                </div>
            </div>
            
            <div class="form-group">
                <label>Sele√ß√£o de Colunas por Arquivo</label>
                <div class="column-tabs" id="columnTabs"></div>
                <div id="columnContainers"></div>
                <p class="column-info">Selecione as colunas que deseja comparar em cada arquivo.</p>
            </div>
            
            <button class="btn btn-success" id="compareBtn">Iniciar Compara√ß√£o (Ctrl+Enter)</button>
        </div>
        
        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <p>Processando arquivos e encontrando semelhan√ßas...</p>
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <p id="progressText">0%</p>
        </div>
        
        <div class="card results-section" id="resultsSection">
            <h2 class="card-title">Resultados da Compara√ß√£o</h2>
            
            <div class="summary-stats" id="summaryStats"></div>
            
            <div class="results-tabs" id="resultsTabs">
                <div class="results-tab active" data-tab="matches">Correspond√™ncias</div>
                <div class="results-tab" data-tab="file1-only">Apenas no Arquivo 1</div>
                <div class="results-tab" data-tab="file2-only">Apenas no Arquivo 2</div>
            </div>
            
            <div id="resultsContainers">
                <div class="results-container active" id="matches-container">
                    <div class="pagination" id="matchesPagination"></div>
                </div>
                <div class="results-container" id="file1-only-container">
                    <div class="pagination" id="file1Pagination"></div>
                </div>
                <div class="results-container" id="file2-only-container">
                    <div class="pagination" id="file2Pagination"></div>
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn btn-success" id="exportMatchesBtn" style="display: none;">Exportar Correspond√™ncias</button>
                <button class="btn btn-warning" id="exportFile1OnlyBtn" style="display: none;">Exportar Apenas Arquivo 1</button>
                <button class="btn btn-warning" id="exportFile2OnlyBtn" style="display: none;">Exportar Apenas Arquivo 2</button>
                <button class="btn" id="exportAllBtn" style="display: none;">Exportar Relat√≥rio Completo</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Comparador de Arquivos Excel &copy; 2023 - Encontre semelhan√ßas entre seus dados</p>
    </footer>

    <script>
        // Vari√°veis globais
        let uploadedFiles = [];
        let fileData = [];
        let selectedColumnsByFile = {};
        let comparisonResults = {};
        let currentPage = {
            matches: 1,
            'file1-only': 1,
            'file2-only': 1
        };
        const pageSize = 50;
        
        // Elementos DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const fileList = document.getElementById('fileList');
        const filePreview = document.getElementById('filePreview');
        const fileTabs = document.getElementById('fileTabs');
        const previewContainers = document.getElementById('previewContainers');
        const clearFilesBtn = document.getElementById('clearFiles');
        const configCard = document.getElementById('configCard');
        const columnTabs = document.getElementById('columnTabs');
        const columnContainers = document.getElementById('columnContainers');
        const searchType = document.getElementById('searchType');
        const similarityThreshold = document.getElementById('similarityThreshold');
        const compareBtn = document.getElementById('compareBtn');
        const loadingSection = document.getElementById('loadingSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const summaryStats = document.getElementById('summaryStats');
        const resultsTabs = document.getElementById('resultsTabs');
        const matchesContainer = document.getElementById('matches-container');
        const file1OnlyContainer = document.getElementById('file1-only-container');
        const file2OnlyContainer = document.getElementById('file2-only-container');
        const exportAllBtn = document.getElementById('exportAllBtn');
        const exportMatchesBtn = document.getElementById('exportMatchesBtn');
        const exportFile1OnlyBtn = document.getElementById('exportFile1OnlyBtn');
        const exportFile2OnlyBtn = document.getElementById('exportFile2OnlyBtn');
        const errorMessage = document.getElementById('errorMessage');

        // Event Listeners
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        clearFilesBtn.addEventListener('click', clearFiles);
        searchType.addEventListener('change', toggleSimilarityThreshold);
        compareBtn.addEventListener('click', startComparison);

        // Atalhos de teclado (Melhoria do primeiro arquivo)
        document.addEventListener('keydown', handleKeyboardShortcuts);

        // Drag and Drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // FUN√á√ÉO DE SIMILARIDADE OTIMIZADA - CORRIGIDA PARA PORCENTAGENS
        function calculateSimilarity(str1, str2) {
            // Converte para string e remove espa√ßos
            const cleanStr1 = str1 !== null && str1 !== undefined ? str1.toString().trim() : '';
            const cleanStr2 = str2 !== null && str2 !== undefined ? str2.toString().trim() : '';
            
            // Se ambos est√£o vazios, considera 100% similar
            if (cleanStr1 === '' && cleanStr2 === '') return 1;
            
            // PRIMEIRO: Tenta detectar e converter porcentagens
            const percentageValue1 = parsePercentage(cleanStr1);
            const percentageValue2 = parsePercentage(cleanStr2);
            
            // Se ambos s√£o porcentagens v√°lidas, compara os valores decimais
            if (percentageValue1 !== null && percentageValue2 !== null) {
                const diff = Math.abs(percentageValue1 - percentageValue2);
                // Para porcentagens, considera alta similaridade se a diferen√ßa for pequena
                if (diff < 0.001) return 1; // 0.1% de diferen√ßa
                if (diff < 0.01) return 0.95; // 1% de diferen√ßa
                if (diff < 0.05) return 0.85; // 5% de diferen√ßa
                return Math.max(0.1, 1 - (diff / Math.max(percentageValue1, percentageValue2)));
            }
            
            // Remove zeros √† esquerda (melhoria do segundo arquivo)
            const noLeadingZero1 = cleanStr1.replace(/^0+/, '');
            const noLeadingZero2 = cleanStr2.replace(/^0+/, '');
            
            if (noLeadingZero1 === noLeadingZero2) return 1;
            
            // Tenta comparar como n√∫meros de forma simples
            const num1 = parseFloat(cleanStr1.replace(/[^\d.,-]/g, '').replace(',', '.'));
            const num2 = parseFloat(cleanStr2.replace(/[^\d.,-]/g, '').replace(',', '.'));
            
            if (!isNaN(num1) && !isNaN(num2)) {
                if (num1 === num2) return 1;
                // Para n√∫meros muito pr√≥ximos, considera alta similaridade
                if (Math.abs(num1 - num2) < 0.0001) return 0.95;
                // Para n√∫meros com pequena diferen√ßa relativa
                const diff = Math.abs(num1 - num2);
                const avg = (Math.abs(num1) + Math.abs(num2)) / 2;
                if (avg > 0 && diff / avg < 0.01) return 0.9; // 1% de diferen√ßa
            }
            
            // Similaridade textual usando abordagem simplificada
            return calculateTextSimilarity(cleanStr1, cleanStr2);
        }
        
        // NOVA FUN√á√ÉO: Converter porcentagens para valores decimais
        function parsePercentage(str) {
            if (!str) return null;
            
            const trimmed = str.toString().trim();
            
            // Detecta se √© uma porcentagem (termina com %)
            if (trimmed.endsWith('%')) {
                const numberPart = trimmed.slice(0, -1).replace(',', '.');
                const value = parseFloat(numberPart);
                if (!isNaN(value)) {
                    return value / 100; // Converte para decimal
                }
            }
            
            // Detecta se √© um n√∫mero decimal que representa porcentagem (entre 0 e 1)
            const decimalValue = parseFloat(trimmed.replace(',', '.'));
            if (!isNaN(decimalValue)) {
                if (decimalValue >= 0 && decimalValue <= 1) {
                    return decimalValue;
                }
                // Se √© um n√∫mero entre 0 e 100, pode ser uma porcentagem sem o s√≠mbolo
                if (decimalValue >= 0 && decimalValue <= 100) {
                    return decimalValue / 100;
                }
            }
            
            return null; // N√£o √© uma porcentagem reconhec√≠vel
        }
        
        function calculateTextSimilarity(str1, str2) {
            if (!str1 || !str2 || str1 === '' || str2 === '') {
                return (str1 === str2) ? 1 : 0;
            }
            
            const normalize = (str) => {
                return str.toString()
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '') // remove acentos
                    .replace(/[^\w\s]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            };
            
            const normStr1 = normalize(str1);
            const normStr2 = normalize(str2);
            
            if (normStr1 === normStr2) return 1;
            
            // Verifica se uma string cont√©m a outra
            if (normStr1.includes(normStr2) || normStr2.includes(normStr1)) {
                const longer = Math.max(normStr1.length, normStr2.length);
                const shorter = Math.min(normStr1.length, normStr2.length);
                return shorter / longer;
            }
            
            // Similaridade por Levenshtein (simples e eficaz)
            return levenshteinSimilarity(normStr1, normStr2);
        }
        
        function levenshteinSimilarity(s1, s2) {
            const distance = levenshteinDistance(s1, s2);
            const maxLength = Math.max(s1.length, s2.length);
            return maxLength === 0 ? 1 : 1 - (distance / maxLength);
        }
        
        function levenshteinDistance(s1, s2) {
            const matrix = [];
            
            for (let i = 0; i <= s2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= s1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= s2.length; i++) {
                for (let j = 1; j <= s1.length; j++) {
                    if (s2.charAt(i - 1) === s1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[s2.length][s1.length];
        }

        // FUN√á√ÉO DE SIMILARIDADE DE CONJUNTO MELHORADA - AGORA √â COMUTATIVA
        function calculateSetSimilarity(values1, values2, isExactSearch) {
            if (values1.length === 0 && values2.length === 0) return 1;
            if (values1.length === 0 || values2.length === 0) return 0;
            
            // Para busca exata, usa compara√ß√£o direta
            if (isExactSearch) {
                const set1 = new Set(values1);
                const set2 = new Set(values2);
                const intersection = new Set([...set1].filter(x => set2.has(x)));
                const union = new Set([...set1, ...set2]);
                return union.size === 0 ? 1 : intersection.size / union.size;
            }
            
            // Para busca por similaridade, usa algoritmo COMUTATIVO melhorado
            let totalSimilarity = 0;
            let totalPossible = 0;
            const usedIndexes2 = new Set();
            
            // Primeira passada: para cada valor em values1, encontra o melhor match em values2
            values1.forEach(val1 => {
                let bestSimilarity = 0;
                let bestIndex = -1;
                
                values2.forEach((val2, j) => {
                    if (usedIndexes2.has(j)) return;
                    
                    const similarity = calculateSimilarity(val1, val2);
                    
                    if (similarity > 0.5 && similarity > bestSimilarity) {
                        bestSimilarity = similarity;
                        bestIndex = j;
                    }
                });
                
                if (bestIndex !== -1) {
                    totalSimilarity += bestSimilarity;
                    usedIndexes2.add(bestIndex);
                }
                totalPossible += 1;
            });
            
            // Segunda passada: para valores restantes em values2 que n√£o foram pareados
            values2.forEach((val2, j) => {
                if (!usedIndexes2.has(j)) {
                    let bestSimilarity = 0;
                    
                    values1.forEach(val1 => {
                        const similarity = calculateSimilarity(val1, val2);
                        if (similarity > 0.5 && similarity > bestSimilarity) {
                            bestSimilarity = similarity;
                        }
                    });
                    
                    if (bestSimilarity > 0) {
                        totalSimilarity += bestSimilarity;
                    }
                    totalPossible += 1;
                }
            });
            
            return totalPossible > 0 ? totalSimilarity / totalPossible : 0;
        }

        // FUN√á√ÉO DE COMPARA√á√ÉO PRINCIPAL CORRIGIDA - AGORA √â INDEPENDENTE DA ORDEM
        function compareCompleteRows(file1, file2, isExactSearch, threshold) {
            const file1Rows = [];
            const file2Rows = [];
            
            // Preparar linhas do arquivo 1 (incluindo valores vazios para consist√™ncia)
            for (let row1 = 1; row1 < file1.data.length; row1++) {
                if (!file1.data[row1]) continue;
                
                const rowValues = [];
                const rowData = {};
                
                selectedColumnsByFile[0].forEach(column => {
                    const colIndex = file1.headers.indexOf(column);
                    if (colIndex !== -1 && file1.data[row1][colIndex] !== undefined) {
                        const value = file1.data[row1][colIndex];
                        // Inclui valores vazios tamb√©m para manter consist√™ncia
                        rowValues.push(value !== null && value !== undefined ? value.toString().trim() : '');
                        rowData[column] = value;
                    }
                });
                
                file1Rows.push({
                    rowIndex: row1,
                    values: rowValues,
                    rowData: rowData,
                    fullRow: file1.data[row1]
                });
            }
            
            // Preparar linhas do arquivo 2 (incluindo valores vazios para consist√™ncia)
            for (let row2 = 1; row2 < file2.data.length; row2++) {
                if (!file2.data[row2]) continue;
                
                const rowValues = [];
                const rowData = {};
                
                selectedColumnsByFile[1].forEach(column => {
                    const colIndex = file2.headers.indexOf(column);
                    if (colIndex !== -1 && file2.data[row2][colIndex] !== undefined) {
                        const value = file2.data[row2][colIndex];
                        // Inclui valores vazios tamb√©m para manter consist√™ncia
                        rowValues.push(value !== null && value !== undefined ? value.toString().trim() : '');
                        rowData[column] = value;
                    }
                });
                
                file2Rows.push({
                    rowIndex: row2,
                    values: rowValues,
                    rowData: rowData,
                    fullRow: file2.data[row2]
                });
            }
            
            // ALGORITMO MELHORADO: Encontrar os melhores matches de forma bidirecional
            const matchedFile1Rows = new Set();
            const matchedFile2Rows = new Set();
            
            // Primeira passada: arquivo1 -> arquivo2
            file1Rows.forEach((row1, row1Index) => {
                let bestMatch = null;
                let bestSimilarity = 0;
                
                file2Rows.forEach((row2, row2Index) => {
                    if (matchedFile2Rows.has(row2Index)) return;
                    
                    const similarity = calculateSetSimilarity(row1.values, row2.values, isExactSearch);
                    
                    if (similarity >= threshold && similarity > bestSimilarity) {
                        bestSimilarity = similarity;
                        bestMatch = { 
                            row2, 
                            row2Index,
                            similarity: similarity
                        };
                    }
                });
                
                if (bestMatch && bestSimilarity >= threshold) {
                    comparisonResults.exactMatches.push({
                        file1: file1.name,
                        row1: row1.rowIndex,
                        file2: file2.name,
                        row2: bestMatch.row2.rowIndex,
                        similarity: Math.round(bestSimilarity * 100),
                        row1Data: row1.rowData,
                        row2Data: bestMatch.row2.rowData,
                        fullRow1: row1.fullRow,
                        fullRow2: bestMatch.row2.fullRow
                    });
                    
                    matchedFile1Rows.add(row1Index);
                    matchedFile2Rows.add(bestMatch.row2Index);
                }
            });
            
            // Segunda passada: arquivo2 -> arquivo1 (para capturar matches que podem ter sido perdidos)
            file2Rows.forEach((row2, row2Index) => {
                if (matchedFile2Rows.has(row2Index)) return;
                
                let bestMatch = null;
                let bestSimilarity = 0;
                
                file1Rows.forEach((row1, row1Index) => {
                    if (matchedFile1Rows.has(row1Index)) return;
                    
                    const similarity = calculateSetSimilarity(row2.values, row1.values, isExactSearch);
                    
                    if (similarity >= threshold && similarity > bestSimilarity) {
                        bestSimilarity = similarity;
                        bestMatch = { 
                            row1, 
                            row1Index,
                            similarity: similarity
                        };
                    }
                });
                
                if (bestMatch && bestSimilarity >= threshold) {
                    comparisonResults.exactMatches.push({
                        file1: file1.name,
                        row1: bestMatch.row1.rowIndex,
                        file2: file2.name,
                        row2: row2.rowIndex,
                        similarity: Math.round(bestSimilarity * 100),
                        row1Data: bestMatch.row1.rowData,
                        row2Data: row2.rowData,
                        fullRow1: bestMatch.row1.fullRow,
                        fullRow2: row2.fullRow
                    });
                    
                    matchedFile1Rows.add(bestMatch.row1Index);
                    matchedFile2Rows.add(row2Index);
                }
            });
            
            // Linhas apenas no arquivo 1
            file1Rows.forEach((row1, row1Index) => {
                if (!matchedFile1Rows.has(row1Index)) {
                    comparisonResults.file1Only.push({
                        file: file1.name,
                        row: row1.rowIndex,
                        rowData: row1.rowData,
                        fullRow: row1.fullRow
                    });
                }
            });
            
            // Linhas apenas no arquivo 2
            file2Rows.forEach((row2, row2Index) => {
                if (!matchedFile2Rows.has(row2Index)) {
                    comparisonResults.file2Only.push({
                        file: file2.name,
                        row: row2.rowIndex,
                        rowData: row2.rowData,
                        fullRow: row2.fullRow
                    });
                }
            });
        }

        // FUN√á√ïES DE PAGINA√á√ÉO
        function getPaginatedData(data, page, pageSize) {
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            return data.slice(start, end);
        }

        function createPagination(totalItems, currentPage, pageSize, containerId, type) {
            const totalPages = Math.ceil(totalItems / pageSize);
            if (totalPages <= 1) return '';

            let paginationHTML = '<div class="pagination">';
            
            // Bot√£o anterior
            if (currentPage > 1) {
                paginationHTML += `<button onclick="changePage('${type}', ${currentPage - 1})">&laquo; Anterior</button>`;
            }

            // P√°ginas
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button onclick="changePage('${type}', ${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<span>...</span>';
                }
            }

            // Bot√£o pr√≥ximo
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="changePage('${type}', ${currentPage + 1})">Pr√≥ximo &raquo;</button>`;
            }

            paginationHTML += `</div><div style="text-align: center; margin-top: 10px; color: #666;">
                P√°gina ${currentPage} de ${totalPages} - Total: ${totalItems} itens
            </div>`;

            return paginationHTML;
        }

        function changePage(type, page) {
            currentPage[type] = page;
            
            switch(type) {
                case 'matches':
                    showMatches();
                    break;
                case 'file1-only':
                    showFile1Only();
                    break;
                case 'file2-only':
                    showFile2Only();
                    break;
            }
        }

        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                if (compareBtn.style.display !== 'none') {
                    startComparison();
                }
            } else if (e.key === 'Escape') {
                clearFiles();
            }
        }

        function updateProgress(percent) {
            progressBar.style.width = percent + '%';
            progressText.textContent = percent + '%';
        }

        function simulateProgress() {
            let width = 0;
            const interval = setInterval(() => {
                width += 5;
                updateProgress(width);
                
                if (width >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        loadingSection.style.display = 'none';
                        performComparison();
                    }, 500);
                }
            }, 100);
        }

        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            errorMessage.style.display = 'none';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    showError(`O arquivo "${file.name}" n√£o √© um arquivo Excel v√°lido.`);
                    continue;
                }
                
                if (uploadedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    showError(`O arquivo "${file.name}" j√° foi adicionado.`);
                    continue;
                }
                
                uploadedFiles.push(file);
                addFileToList(file);
            }
            
            if (uploadedFiles.length > 0) {
                clearFilesBtn.style.display = 'inline-block';
                configCard.style.display = 'block';
            }
            
            fileInput.value = '';
            processFilesForColumns();
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function addFileToList(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileInfo = document.createElement('div');
            fileInfo.innerHTML = `
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
            `;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-danger';
            removeBtn.textContent = 'Remover';
            removeBtn.addEventListener('click', () => removeFile(file));
            
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(removeBtn);
            fileList.appendChild(fileItem);
        }
        
        function removeFile(fileToRemove) {
            uploadedFiles = uploadedFiles.filter(file => file !== fileToRemove);
            fileList.innerHTML = '';
            
            uploadedFiles.forEach(file => addFileToList(file));
            
            if (uploadedFiles.length === 0) {
                clearFilesBtn.style.display = 'none';
                configCard.style.display = 'none';
                filePreview.style.display = 'none';
            } else {
                processFilesForColumns();
            }
        }
        
        function clearFiles() {
            // Limpeza completa de todas as vari√°veis de estado
            uploadedFiles = [];
            fileData = [];
            selectedColumnsByFile = {};
            comparisonResults = {};
            currentPage = {
                matches: 1,
                'file1-only': 1,
                'file2-only': 1
            };
            
            // Limpeza da interface
            fileList.innerHTML = '';
            fileTabs.innerHTML = '';
            previewContainers.innerHTML = '';
            columnTabs.innerHTML = '';
            columnContainers.innerHTML = '';
            
            // Esconder elementos
            clearFilesBtn.style.display = 'none';
            configCard.style.display = 'none';
            filePreview.style.display = 'none';
            resultsSection.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Reset do file input
            fileInput.value = '';
            
            console.log('Estado completamente limpo'); // Para debug
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function toggleSimilarityThreshold() {
            similarityThreshold.disabled = searchType.value === 'exact';
        }
        
        function processFilesForColumns() {
            if (uploadedFiles.length === 0) return;
            
            // RESET COMPLETO ao processar novos arquivos
            fileData = [];
            selectedColumnsByFile = {};
            
            // Limpar interfaces
            fileTabs.innerHTML = '';
            previewContainers.innerHTML = '';
            columnTabs.innerHTML = '';
            columnContainers.innerHTML = '';
            
            filePreview.style.display = 'block';
            
            let processedCount = 0;
            
            uploadedFiles.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        console.log(`Arquivo processado: ${file.name}`, {
                            linhas: jsonData.length,
                            colunas: jsonData[0] ? jsonData[0].length : 0,
                            headers: jsonData[0] || []
                        });
                        
                        const fileInfo = {
                            name: file.name,
                            data: jsonData,
                            headers: jsonData[0] || []
                        };
                        
                        fileData.push(fileInfo);
                        addFilePreview(file.name, jsonData, index);
                        addColumnSelection(file.name, fileInfo.headers, index);
                        
                        processedCount++;
                        
                        if (processedCount === uploadedFiles.length) {
                            console.log('Todos os arquivos processados:', fileData);
                            activateTab(0);
                            activateColumnTab(0);
                        }
                    } catch (error) {
                        console.error('Erro detalhado ao processar arquivo:', error);
                        showError(`Erro ao processar o arquivo "${file.name}": ${error.message}`);
                    }
                };
                
                reader.onerror = function() {
                    showError(`Erro ao ler o arquivo: ${file.name}`);
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        function addFilePreview(fileName, data, index) {
            const tab = document.createElement('div');
            tab.className = 'file-tab';
            tab.textContent = fileName;
            tab.dataset.index = index;
            tab.addEventListener('click', () => activateTab(index));
            fileTabs.appendChild(tab);
            
            const container = document.createElement('div');
            container.className = 'preview-container';
            container.id = `preview-${index}`;
            
            let tableHTML = `<table class="preview-table"><thead><tr>`;
            
            if (data.length > 0 && data[0]) {
                data[0].forEach(header => {
                    tableHTML += `<th>${header || ''}</th>`;
                });
                tableHTML += `</tr></thead><tbody>`;
                
                const rowCount = Math.min(data.length, 11);
                for (let i = 1; i < rowCount; i++) {
                    if (data[i]) {
                        tableHTML += `<tr>`;
                        data[i].forEach(cell => {
                            // Destaca c√©lulas que podem conter porcentagens
                            const cellValue = cell || '';
                            const isPercentage = typeof cellValue === 'string' && 
                                (cellValue.includes('%') || 
                                 (parsePercentage(cellValue) !== null && parsePercentage(cellValue) <= 1));
                            const cellClass = isPercentage ? 'percentage-cell' : '';
                            tableHTML += `<td class="${cellClass}">${cellValue}</td>`;
                        });
                        tableHTML += `</tr>`;
                    }
                }
                
                tableHTML += `</tbody></table>`;
                
                if (data.length > 10) {
                    tableHTML += `<p style="margin-top: 10px; font-style: italic;">Mostrando 10 de ${data.length-1} linhas</p>`;
                }
            } else {
                tableHTML = '<p>Arquivo vazio ou sem dados</p>';
            }
            
            container.innerHTML = tableHTML;
            previewContainers.appendChild(container);
        }
        
        function addColumnSelection(fileName, headers, index) {
            const tab = document.createElement('div');
            tab.className = 'column-tab';
            tab.textContent = fileName;
            tab.dataset.index = index;
            tab.addEventListener('click', () => activateColumnTab(index));
            columnTabs.appendChild(tab);
            
            const container = document.createElement('div');
            container.className = 'column-container';
            container.id = `column-${index}`;
            
            const validHeaders = headers.filter(header => header && header.toString().trim() !== '');
            
            if (validHeaders.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #c0392b;">Nenhuma coluna v√°lida encontrada neste arquivo.</p>';
            } else {
                const selectAllContainer = document.createElement('div');
                selectAllContainer.className = 'select-all-container';
                
                const selectAllGroup = document.createElement('div');
                selectAllGroup.className = 'checkbox-group';
                
                const selectAllCheckbox = document.createElement('input');
                selectAllCheckbox.type = 'checkbox';
                selectAllCheckbox.id = `select-all-${index}`;
                selectAllCheckbox.checked = true;
                selectAllCheckbox.addEventListener('change', function() {
                    const container = document.getElementById(`column-${index}`);
                    if (!container) return;
                    
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([id^="select-all-"])');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateSelectedColumnsForFile(index);
                });
                
                const selectAllLabel = document.createElement('label');
                selectAllLabel.htmlFor = `select-all-${index}`;
                selectAllLabel.textContent = 'Selecionar Todas as Colunas';
                selectAllLabel.style.fontWeight = 'bold';
                
                selectAllGroup.appendChild(selectAllCheckbox);
                selectAllGroup.appendChild(selectAllLabel);
                selectAllContainer.appendChild(selectAllGroup);
                container.appendChild(selectAllContainer);
                
                const columnsContainer = document.createElement('div');
                columnsContainer.className = 'column-selection-container';
                
                validHeaders.forEach(header => {
                    const checkboxGroup = document.createElement('div');
                    checkboxGroup.className = 'checkbox-group';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `col-${index}-${header.replace(/\s+/g, '-')}`;
                    checkbox.value = header;
                    checkbox.checked = true;
                    checkbox.addEventListener('change', () => updateSelectedColumnsForFile(index));
                    
                    const label = document.createElement('label');
                    label.htmlFor = `col-${index}-${header.replace(/\s+/g, '-')}`;
                    label.textContent = header;
                    
                    checkboxGroup.appendChild(checkbox);
                    checkboxGroup.appendChild(label);
                    columnsContainer.appendChild(checkboxGroup);
                });
                
                container.appendChild(columnsContainer);
                updateSelectedColumnsForFile(index);
            }
            
            columnContainers.appendChild(container);
        }
        
        function activateTab(index) {
            document.querySelectorAll('.file-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.preview-container').forEach(container => {
                container.classList.remove('active');
            });
            
            const tab = document.querySelector(`.file-tab[data-index="${index}"]`);
            const container = document.getElementById(`preview-${index}`);
            
            if (tab) tab.classList.add('active');
            if (container) container.classList.add('active');
        }
        
        function activateColumnTab(index) {
            document.querySelectorAll('.column-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.column-container').forEach(container => {
                container.classList.remove('active');
            });
            
            const tab = document.querySelector(`.column-tab[data-index="${index}"]`);
            const container = document.getElementById(`column-${index}`);
            
            if (tab) tab.classList.add('active');
            if (container) container.classList.add('active');
        }
        
        function updateSelectedColumnsForFile(fileIndex) {
            const container = document.getElementById(`column-${fileIndex}`);
            if (!container) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([id^="select-all-"])');
            const selectedColumns = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedColumns.push(checkbox.value);
                }
            });
            
            selectedColumnsByFile[fileIndex] = selectedColumns;
            
            const selectAllCheckbox = document.getElementById(`select-all-${fileIndex}`);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedColumns.length === checkboxes.length;
            }
        }
        
        function startComparison() {
            // VALIDA√á√ÉO EXPANDIDA
            if (uploadedFiles.length < 2) {
                showError('Por favor, fa√ßa upload de pelo menos 2 arquivos para comparar.');
                return;
            }
            
            // Verificar se os arquivos foram processados corretamente
            if (fileData.length !== uploadedFiles.length) {
                showError('Erro: Arquivos n√£o foram processados completamente. Tente fazer upload novamente.');
                return;
            }
            
            // Verificar se h√° dados nos arquivos
            for (let i = 0; i < fileData.length; i++) {
                if (!fileData[i] || !fileData[i].data || fileData[i].data.length === 0) {
                    showError(`O arquivo "${uploadedFiles[i].name}" est√° vazio ou n√£o p√¥de ser processado.`);
                    return;
                }
                
                if (!selectedColumnsByFile[i] || selectedColumnsByFile[i].length === 0) {
                    showError(`Por favor, selecione pelo menos uma coluna no arquivo "${fileData[i].name}".`);
                    activateColumnTab(i);
                    return;
                }
                
                // Verificar se as colunas selecionadas existem nos dados
                const missingColumns = selectedColumnsByFile[i].filter(col => 
                    !fileData[i].headers.includes(col)
                );
                
                if (missingColumns.length > 0) {
                    showError(`Colunas selecionadas n√£o encontradas no arquivo "${fileData[i].name}": ${missingColumns.join(', ')}`);
                    activateColumnTab(i);
                    return;
                }
            }
            
            // Debug: log dos dados que ser√£o comparados
            console.log('Arquivos para compara√ß√£o:', fileData.map(f => f.name));
            console.log('Colunas selecionadas:', selectedColumnsByFile);
            
            loadingSection.style.display = 'block';
            resultsSection.style.display = 'none';
            updateProgress(0);
            
            setTimeout(() => {
                simulateProgress();
            }, 500);
        }
        
        function performComparison() {
            // RESET COMPLETO dos resultados anteriores
            comparisonResults = {
                exactMatches: [],
                file1Only: [],
                file2Only: []
            };
            
            // Reset das p√°ginas
            currentPage = {
                matches: 1,
                'file1-only': 1,
                'file2-only': 1
            };
            
            console.log('Iniciando nova compara√ß√£o com:', {
                arquivo1: fileData[0]?.name,
                arquivo2: fileData[1]?.name,
                colunasArq1: selectedColumnsByFile[0],
                colunasArq2: selectedColumnsByFile[1]
            });
            
            const isExactSearch = searchType.value === 'exact';
            const threshold = parseInt(similarityThreshold.value) / 100;
            
            if (fileData.length >= 2) {
                const file1 = fileData[0];
                const file2 = fileData[1];
                compareCompleteRows(file1, file2, isExactSearch, threshold);
            }
            
            console.log('Resultados da compara√ß√£o:', comparisonResults);
            showResults();
        }
        
        function showResults() {
            resultsSection.style.display = 'block';
            setupResultsTabs();
            showSummaryStats();
            showMatches();
            showFile1Only();
            showFile2Only();
            showExportButtons();
        }
        
        function setupResultsTabs() {
            const tabs = document.querySelectorAll('.results-tab');
            const containers = document.querySelectorAll('.results-container');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    containers.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tabName}-container`).classList.add('active');
                });
            });
        }
        
        function showSummaryStats() {
            const statsHTML = `
                <div class="stat-card match">
                    <div class="stat-value">${comparisonResults.exactMatches.length}</div>
                    <div class="stat-label">Correspond√™ncias</div>
                </div>
                <div class="stat-card file1-only">
                    <div class="stat-value">${comparisonResults.file1Only.length}</div>
                    <div class="stat-label">Apenas no Arquivo 1</div>
                </div>
                <div class="stat-card file2-only">
                    <div class="stat-value">${comparisonResults.file2Only.length}</div>
                    <div class="stat-label">Apenas no Arquivo 2</div>
                </div>
            `;
            
            summaryStats.innerHTML = statsHTML;
        }
        
        function showMatches() {
            if (comparisonResults.exactMatches.length === 0) {
                matchesContainer.innerHTML = '<div class="no-results"><p>Nenhuma correspond√™ncia encontrada com o limiar de similaridade configurado.</p><p>Tente reduzir o limiar de similaridade m√≠nima.</p></div>';
                return;
            }
            
            const selectedCols1 = selectedColumnsByFile[0] || [];
            const selectedCols2 = selectedColumnsByFile[1] || [];
            const paginatedData = getPaginatedData(comparisonResults.exactMatches, currentPage.matches, pageSize);
            
            let tableHTML = `
                <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Similaridade</th>
                            <th>Arquivo 1 - Linha</th>
                            <th>Arquivo 2 - Linha</th>
            `;
            
            // Cabe√ßalhos das colunas selecionadas - mostrando ambas as vers√µes
            selectedCols1.forEach((col, index) => {
                const col2 = selectedCols2[index] || col;
                tableHTML += `<th>${col} (Arq1) ‚Üî ${col2} (Arq2)</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            paginatedData.forEach(match => {
                const similarityClass = match.similarity >= 90 ? 'high-similarity' : '';
                
                tableHTML += `
                    <tr class="match-row comparison-row">
                        <td class="${similarityClass}">${match.similarity}%</td>
                        <td>${match.row1 + 1}</td>
                        <td>${match.row2 + 1}</td>
                `;
                
                // Dados das colunas selecionadas - mostrando ambos os valores
                selectedCols1.forEach((col, index) => {
                    const col2 = selectedCols2[index] || col;
                    const value1 = match.row1Data[col] || '';
                    const value2 = match.row2Data[col2] || '';
                    
                    // Destaca c√©lulas com porcentagens
                    const isPercentage1 = typeof value1 === 'string' && value1.includes('%');
                    const isPercentage2 = typeof value2 === 'string' && value2.includes('%');
                    const cellClass1 = isPercentage1 ? 'percentage-cell' : '';
                    const cellClass2 = isPercentage2 ? 'percentage-cell' : '';
                    
                    tableHTML += `<td>
                        <strong>Arq1:</strong> <span class="${cellClass1}">${value1}</span><br>
                        <strong>Arq2:</strong> <span class="${cellClass2}">${value2}</span>
                    </td>`;
                });
                
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            
            const paginationHTML = createPagination(
                comparisonResults.exactMatches.length, 
                currentPage.matches, 
                pageSize, 
                'matchesPagination', 
                'matches'
            );
            
            matchesContainer.innerHTML = tableHTML + paginationHTML;
        }
        
        function showFile1Only() {
            if (comparisonResults.file1Only.length === 0) {
                file1OnlyContainer.innerHTML = '<div class="no-results"><p>Nenhuma linha encontrada apenas no Arquivo 1.</p></div>';
                return;
            }
            
            const selectedCols = selectedColumnsByFile[0] || [];
            const paginatedData = getPaginatedData(comparisonResults.file1Only, currentPage['file1-only'], pageSize);
            
            let tableHTML = `
                <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Linha</th>
            `;
            
            selectedCols.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            paginatedData.forEach(item => {
                tableHTML += `
                    <tr class="only-in-file1">
                        <td>${item.row + 1}</td>
                `;
                
                selectedCols.forEach(col => {
                    const value = item.rowData[col] || '';
                    const isPercentage = typeof value === 'string' && value.includes('%');
                    const cellClass = isPercentage ? 'percentage-cell' : '';
                    tableHTML += `<td class="${cellClass}">${value}</td>`;
                });
                
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            
            const paginationHTML = createPagination(
                comparisonResults.file1Only.length, 
                currentPage['file1-only'], 
                pageSize, 
                'file1Pagination', 
                'file1-only'
            );
            
            file1OnlyContainer.innerHTML = tableHTML + paginationHTML;
        }
        
        function showFile2Only() {
            if (comparisonResults.file2Only.length === 0) {
                file2OnlyContainer.innerHTML = '<div class="no-results"><p>Nenhuma linha encontrada apenas no Arquivo 2.</p></div>';
                return;
            }
            
            const selectedCols = selectedColumnsByFile[1] || [];
            const paginatedData = getPaginatedData(comparisonResults.file2Only, currentPage['file2-only'], pageSize);
            
            let tableHTML = `
                <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Linha</th>
            `;
            
            selectedCols.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            paginatedData.forEach(item => {
                tableHTML += `
                    <tr class="only-in-file2">
                        <td>${item.row + 1}</td>
                `;
                
                selectedCols.forEach(col => {
                    const value = item.rowData[col] || '';
                    const isPercentage = typeof value === 'string' && value.includes('%');
                    const cellClass = isPercentage ? 'percentage-cell' : '';
                    tableHTML += `<td class="${cellClass}">${value}</td>`;
                });
                
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            
            const paginationHTML = createPagination(
                comparisonResults.file2Only.length, 
                currentPage['file2-only'], 
                pageSize, 
                'file2Pagination', 
                'file2-only'
            );
            
            file2OnlyContainer.innerHTML = tableHTML + paginationHTML;
        }
        
        function showExportButtons() {
            exportMatchesBtn.style.display = 'inline-block';
            exportFile1OnlyBtn.style.display = 'inline-block';
            exportFile2OnlyBtn.style.display = 'inline-block';
            exportAllBtn.style.display = 'inline-block';
            
            exportMatchesBtn.onclick = () => exportToExcel('matches');
            exportFile1OnlyBtn.onclick = () => exportToExcel('file1-only');
            exportFile2OnlyBtn.onclick = () => exportToExcel('file2-only');
            exportAllBtn.onclick = () => exportToExcel('all');
        }
        
        function exportToExcel(type) {
            const wb = XLSX.utils.book_new();
            
            switch(type) {
                case 'matches':
                    if (comparisonResults.exactMatches.length > 0) {
                        const data = prepareMatchesData();
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        XLSX.utils.book_append_sheet(wb, ws, 'Correspondencias');
                        XLSX.writeFile(wb, 'correspondencias.xlsx');
                    } else {
                        alert('N√£o h√° correspond√™ncias para exportar.');
                    }
                    break;
                    
                case 'file1-only':
                    if (comparisonResults.file1Only.length > 0) {
                        const data = prepareFileOnlyData(comparisonResults.file1Only, 0);
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        XLSX.utils.book_append_sheet(wb, ws, 'Apenas_Arquivo1');
                        XLSX.writeFile(wb, 'apenas_arquivo1.xlsx');
                    } else {
                        alert('N√£o h√° linhas apenas no Arquivo 1 para exportar.');
                    }
                    break;
                    
                case 'file2-only':
                    if (comparisonResults.file2Only.length > 0) {
                        const data = prepareFileOnlyData(comparisonResults.file2Only, 1);
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        XLSX.utils.book_append_sheet(wb, ws, 'Apenas_Arquivo2');
                        XLSX.writeFile(wb, 'apenas_arquivo2.xlsx');
                    } else {
                        alert('N√£o h√° linhas apenas no Arquivo 2 para exportar.');
                    }
                    break;
                    
                case 'all':
                    exportAllSheets(wb);
                    XLSX.writeFile(wb, 'relatorio_completo.xlsx');
                    break;
            }
        }
        
        function prepareMatchesData() {
            const selectedCols1 = selectedColumnsByFile[0] || [];
            const selectedCols2 = selectedColumnsByFile[1] || [];
            
            const data = [
                ['CORRESPOND√äNCIAS ENCONTRADAS'],
                [],
                ['Similaridade', 'Arquivo 1 - Linha', 'Arquivo 2 - Linha']
            ];
            
            // Adicionar cabe√ßalhos para as colunas selecionadas
            const headers = ['Similaridade', 'Arquivo 1 - Linha', 'Arquivo 2 - Linha'];
            selectedCols1.forEach((col, index) => {
                const col2 = selectedCols2[index] || col;
                headers.push(`${col} (Arq1)`);
                headers.push(`${col2} (Arq2)`);
            });
            data[2] = headers;
            
            comparisonResults.exactMatches.forEach(match => {
                const row = [
                    `${match.similarity}%`,
                    match.row1 + 1,
                    match.row2 + 1
                ];
                
                // Adicionar dados das colunas selecionadas
                selectedCols1.forEach((col, index) => {
                    const col2 = selectedCols2[index] || col;
                    const value1 = match.row1Data[col] || '';
                    const value2 = match.row2Data[col2] || '';
                    row.push(value1);
                    row.push(value2);
                });
                
                data.push(row);
            });
            
            return data;
        }
        
        function prepareFileOnlyData(items, fileIndex) {
            const selectedCols = selectedColumnsByFile[fileIndex] || [];
            const fileName = fileData[fileIndex].name;
            
            const data = [
                [`LINHAS APENAS NO ${fileName.toUpperCase()}`],
                [],
                ['Linha', ...selectedCols]
            ];
            
            items.forEach(item => {
                const row = [item.row + 1];
                
                selectedCols.forEach(col => {
                    row.push(item.rowData[col] || '');
                });
                
                data.push(row);
            });
            
            return data;
        }
        
        function exportAllSheets(wb) {
            let hasData = false;
            
            if (comparisonResults.exactMatches.length > 0) {
                const data = prepareMatchesData();
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Correspondencias');
                hasData = true;
            }
            
            if (comparisonResults.file1Only.length > 0) {
                const data = prepareFileOnlyData(comparisonResults.file1Only, 0);
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Apenas_Arquivo1');
                hasData = true;
            }
            
            if (comparisonResults.file2Only.length > 0) {
                const data = prepareFileOnlyData(comparisonResults.file2Only, 1);
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Apenas_Arquivo2');
                hasData = true;
            }
            
            if (!hasData) {
                alert('N√£o h√° dados para exportar.');
            }
        }
        
        // Inicializar
        toggleSimilarityThreshold();
    </script>
</body>
</html>
